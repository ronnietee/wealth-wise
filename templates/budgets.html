{% extends "base.html" %}

{% block title %}Budget Management - STEWARD{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Budget Management</h1>
        <p class="page-subtitle">Create and manage your budget periods</p>
    </div>

    <!-- Header with Create Button and Filter -->
    <div class="budgets-header">
        <div class="header-left">
            <button class="btn btn-primary create-budget-btn" onclick="toggleCreateForm()">
                <i class="fas fa-plus"></i>
                Create Budget
            </button>
        </div>
        <div class="header-right">
            <div class="filter-container">
                <select id="periodTypeFilter" class="filter-select">
                    <option value="all">All Types</option>
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Create New Budget Period (Collapsible) -->
    <div class="card create-budget-card" id="create-budget-card" style="display: none;">
        <div class="card-body">
            <form id="create-budget-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="budget-name">Budget Name</label>
                        <input type="text" id="budget-name" name="name" required 
                               placeholder="e.g., January 2024, Q1 2024">
                    </div>
                    <div class="form-group">
                        <label for="period-type">Period Type</label>
                        <select id="period-type" name="period_type" required>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date" name="start_date" required>
                    </div>
                    <div class="form-group">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date" name="end_date" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Create Budget Period</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleCreateForm()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Periods List -->
    <div class="card">
        <div class="card-body">
            <div class="table-container">
                <table class="budgets-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Period</th>
                            <th>Created</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="budget-periods-list">
                        <tr>
                            <td colspan="6" class="loading">Loading budget periods...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let userCurrency = 'USD';
let allPeriods = []; // Store all periods for filtering

// Toggle create budget form
function toggleCreateForm() {
    const createCard = document.getElementById('create-budget-card');
    const createBtn = document.querySelector('.create-budget-btn');
    
    if (createCard.style.display === 'none') {
        createCard.style.display = 'block';
        createBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
        createBtn.classList.remove('btn-primary');
        createBtn.classList.add('btn-secondary');
    } else {
        createCard.style.display = 'none';
        createBtn.innerHTML = '<i class="fas fa-plus"></i> Create Budget';
        createBtn.classList.remove('btn-secondary');
        createBtn.classList.add('btn-primary');
        // Reset form
        document.getElementById('create-budget-form').reset();
    }
}

// Format currency function
function formatCurrency(amount, currency = 'USD') {
    const symbol = getCurrencySymbol(currency);
    const formatter = new Intl.NumberFormat('en-US', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    return symbol + formatter.format(amount || 0);
}

// Get currency symbol
function getCurrencySymbol(currency) {
    const symbols = {
        'USD': '$',
        'EUR': '€',
        'GBP': '£',
        'ZAR': 'R',
        'CAD': 'C$',
        'AUD': 'A$',
        'BWP': 'P',
        'ZMW': 'K',
        'NGN': '₦',
        'KES': 'KSh',
        'GHS': '₵',
        'UGX': 'USh',
        'TZS': 'TSh',
        'ETB': 'Br',
        'RWF': 'RF',
        'MWK': 'MK',
        'BRL': 'R$',
        'MXN': '$',
        'PHP': '₱',
        'INR': '₹',
        'JPY': '¥'
    };
    return symbols[currency] || '$';
}

// Load user settings first
async function loadUserSettings() {
    try {
        const response = await fetch('/api/user/settings', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (response.ok) {
            const settings = await response.json();
            userCurrency = settings.currency;
            document.dispatchEvent(new CustomEvent('currencyLoaded'));
        }
    } catch (error) {
        console.error('Error loading user settings:', error);
    }
}

// Load current active budget
async function loadCurrentBudget() {
    try {
        const response = await fetch('/api/budget', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (response.ok) {
            const budget = await response.json();
            if (budget.error) {
                throw new Error(budget.error);
            }
            // Budget loaded successfully - no need to display anything since we removed the current budget section
            return budget;
        } else if (response.status === 404) {
            // No budget found - this is expected when no budget exists
            return null;
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error loading current budget:', error);
        // Don't show error for 404 (no budget) cases
        if (!error.message.includes('404')) {
            showNotification('Error loading current budget: ' + error.message, 'error');
        }
        return null;
    }
}

// Load all budget periods
async function loadBudgetPeriods() {
    try {
        const response = await fetch('/api/budget-periods', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (response.ok) {
            const periods = await response.json();
            if (periods.error) {
                throw new Error(periods.error);
            }
            console.log('Loaded budget periods:', periods);
            allPeriods = periods; // Store all periods for filtering
            renderBudgetPeriods(periods);
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error loading budget periods:', error);
        document.getElementById('budget-periods-list').innerHTML = `<p>Error loading budget periods: ${error.message}</p>`;
    }
}

// Filter periods by type
function filterPeriodsByType(periodType) {
    if (periodType === 'all') {
        renderBudgetPeriods(allPeriods);
    } else {
        const filteredPeriods = allPeriods.filter(period => period.period_type === periodType);
        renderBudgetPeriods(filteredPeriods);
    }
}

// Render periods (extracted from loadBudgetPeriods)
function renderBudgetPeriods(periods) {
    console.log('Rendering budget periods:', periods);
    const periodsList = document.getElementById('budget-periods-list');
    
    if (periods.length === 0) {
        console.log('No periods found, showing no-data message');
        periodsList.innerHTML = '<tr><td colspan="6" class="no-data">No budget periods found. Create your first budget period above.</td></tr>';
        return;
    }
    
    periodsList.innerHTML = periods.map(period => `
        <tr class="budget-period-row ${period.is_active ? 'active' : ''}">
            <td class="period-name">${period.name}</td>
            <td class="period-type">
                <span class="type-badge ${period.period_type}">${period.period_type}</span>
            </td>
            <td class="period-dates">
                ${period.start_date || 'N/A'} to ${period.end_date || 'N/A'}
            </td>
            <td class="period-created">
                ${period.created_at ? new Date(period.created_at).toLocaleDateString() : 'N/A'}
            </td>
            <td class="period-status">
                ${period.is_active ? 
                    '<span class="badge badge-success">Active</span>' : 
                    '<span class="badge badge-secondary">Inactive</span>'
                }
            </td>
            <td class="period-actions">
                <div class="action-buttons">
                    ${period.is_active ? 
                        '' : 
                        `<button class="btn btn-sm btn-primary" onclick="activateBudgetPeriod(${period.id})" title="Activate">
                            <i class="fas fa-play"></i>
                        </button>`
                    }
                    <button class="btn btn-sm btn-danger" onclick="deleteBudgetPeriod(${period.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Activate a budget period
async function activateBudgetPeriod(periodId) {
    try {
        const response = await fetch(`/api/budget-periods/${periodId}/activate`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            // Reload both current budget and periods list
            await loadCurrentBudget();
            await loadBudgetPeriods();
            showNotification('Budget period activated successfully!', 'success');
            
            // Dispatch event to notify other pages of budget period change
            console.log('Dispatching budgetPeriodChanged event');
            document.dispatchEvent(new CustomEvent('budgetPeriodChanged'));
        } else {
            const error = await response.json();
            showNotification(error.message || 'Failed to activate budget period', 'error');
        }
    } catch (error) {
        console.error('Error activating budget period:', error);
        showNotification('Error activating budget period', 'error');
    }
}

// Delete a budget period
async function deleteBudgetPeriod(periodId) {
    // Find the period name for confirmation
    const period = allPeriods.find(p => p.id === periodId);
    if (!period) {
        showMessage('Budget period not found', 'error');
        return;
    }
    
    // Confirm deletion
    const confirmed = confirm(`Are you sure you want to delete "${period.name}"?\n\nThis will permanently delete:\n- The budget period\n- All budget allocations\n- All transactions\n- All income sources\n- All other related data\n\nThis action cannot be undone.`);
    
    if (!confirmed) {
        return;
    }
    
    try {
        const response = await fetch(`/api/budget-periods/${periodId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (response.ok) {
            showNotification('Budget period and all related data deleted successfully!', 'success');
            
            // Reload the budget periods list
            console.log('Reloading budget periods after deletion...');
            await loadBudgetPeriods();
            await loadCurrentBudget();
            
            // Dispatch event to notify other pages of budget period change
            console.log('Dispatching budgetPeriodChanged event (deletion)');
            document.dispatchEvent(new CustomEvent('budgetPeriodChanged'));
        } else {
            const error = await response.json();
            showNotification(error.message || 'Failed to delete budget period', 'error');
        }
    } catch (error) {
        console.error('Error deleting budget period:', error);
        showNotification('Error deleting budget period', 'error');
    }
}

// Handle form submission
document.getElementById('create-budget-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        name: formData.get('name'),
        period_type: formData.get('period_type'),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date')
    };
    
    try {
        const response = await fetch('/api/budget-periods', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const newPeriod = await response.json();
            showNotification('Budget period created successfully!', 'success');
            e.target.reset();
            
            // Reload the budget periods list
            console.log('Reloading budget periods after creation...');
            await loadBudgetPeriods();
            await loadCurrentBudget();
            
            // Close the create form
            toggleCreateForm();
            
            // Dispatch event to notify other pages of budget period change
            console.log('Dispatching budgetPeriodChanged event (new period)');
            document.dispatchEvent(new CustomEvent('budgetPeriodChanged'));
        } else {
            const error = await response.json();
            showNotification(error.message || 'Failed to create budget period', 'error');
        }
    } catch (error) {
        console.error('Error creating budget period:', error);
        showNotification('Error creating budget period', 'error');
    }
});

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('start-date').value = startOfMonth.toISOString().split('T')[0];
    document.getElementById('end-date').value = endOfMonth.toISOString().split('T')[0];
    
    // Load data
    loadUserSettings().then(() => {
        loadCurrentBudget();
        loadBudgetPeriods();
    });
    
    // Setup period type filter
    document.getElementById('periodTypeFilter').addEventListener('change', function() {
        filterPeriodsByType(this.value);
    });
});

// Auto-update dates based on period type
document.getElementById('period-type').addEventListener('change', function() {
    const periodType = this.value;
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const nameInput = document.getElementById('budget-name');
    
    const today = new Date();
    let startDate, endDate, name;
    
    switch (periodType) {
        case 'monthly':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            name = startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            break;
        case 'quarterly':
            const quarter = Math.floor(today.getMonth() / 3);
            startDate = new Date(today.getFullYear(), quarter * 3, 1);
            endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
            name = `Q${quarter + 1} ${today.getFullYear()}`;
            break;
        case 'yearly':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            name = today.getFullYear().toString();
            break;
        default:
            return; // Don't auto-fill for custom
    }
    
    startDateInput.value = startDate.toISOString().split('T')[0];
    endDateInput.value = endDate.toISOString().split('T')[0];
    nameInput.value = name;
});

</script>

<style>
.budget-period-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 1rem;
    background: #f9f9f9;
}

.budget-period-item.active {
    background: #e8f5e8;
    border-color: #4caf50;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.period-type-filter {
    display: flex;
    align-items: center;
    gap: 8px;
}

.period-type-filter select {
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
}

.period-info h4 {
    margin: 0 0 0.5rem 0;
    color: #333;
}

.period-info p {
    margin: 0.25rem 0;
    color: #666;
    font-size: 0.9rem;
}

.period-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
}

.badge-success {
    background: #4caf50;
    color: white;
}

.budget-info {
    padding: 1rem;
    background: #f0f8ff;
    border-radius: 8px;
    border-left: 4px solid #2196f3;
}

.budget-info h4 {
    margin: 0 0 1rem 0;
    color: #1976d2;
}

.budget-info p {
    margin: 0.5rem 0;
    color: #333;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .budget-period-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .period-actions {
        width: 100%;
        justify-content: flex-end;
    }
}
</style>
{% endblock %}
