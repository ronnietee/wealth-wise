{% extends "base.html" %}

{% block title %}Budget Management - STEWARD{% endblock %}

{% block head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Budget Management</h1>
        <p class="page-subtitle">Create and manage your budget periods</p>
    </div>

    <!-- Header with Create Button and Filter -->
    <div class="budgets-header">
        <div class="header-left">
            <button class="btn btn-primary create-budget-btn" onclick="toggleCreateForm()">
                <i class="fas fa-plus"></i>
                Create Budget
            </button>
        </div>
        <div class="header-right">
            <div class="filter-container">
                <select id="periodTypeFilter" class="filter-select">
                    <option value="all">All Types</option>
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Create New Budget Period (Collapsible) -->
    <div class="card create-budget-card" id="create-budget-card" style="display: none;">
        <div class="card-body">
            <form id="create-budget-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="budget-name">Budget Name</label>
                        <input type="text" id="budget-name" name="name" required 
                               placeholder="e.g., January 2024, Q1 2024">
                    </div>
                    <div class="form-group">
                        <label for="period-type">Period Type</label>
                        <select id="period-type" name="period_type" required>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date" name="start_date" required>
                    </div>
                    <div class="form-group">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date" name="end_date" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Create Budget Period</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleCreateForm()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Information Section -->
    <div class="card info-card">
        <div class="card-header">
            <h3><i class="fas fa-info-circle"></i> How Budget Periods Work</h3>
        </div>
        <div class="card-body">
            <div class="info-content">
                <div class="info-section">
                    <h4><i class="fas fa-calendar-alt"></i> Single Active Period</h4>
                    <p>Only one budget period can be active at a time. When you activate a period, all others become inactive.</p>
                </div>
                <div class="info-section">
                    <h4><i class="fas fa-layer-group"></i> Independent Allocations</h4>
                    <p>Each period has its own budget allocations. You can allocate $1000 to groceries monthly and $5000 quarterly - these are separate budgets.</p>
                </div>
                <div class="info-section">
                    <h4><i class="fas fa-receipt"></i> Transaction Attribution</h4>
                    <p>Transactions appear in any period they fall within based on their date. A March transaction shows in both March and Q1 periods.</p>
                </div>
                <div class="info-section">
                    <h4><i class="fas fa-exclamation-triangle"></i> Overspending Detection</h4>
                    <p>Overspending is checked against the active period's allocations. You might be overspent monthly but fine quarterly.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Periods List -->
    <div class="card">
        <div class="card-header">
            <h3>Budget Periods</h3>
            <!-- Mobile expand/collapse button -->
            <button class="mobile-toggle-btn" id="mobile-periods-toggle" onclick="toggleMobilePeriods()">
                <i class="fas fa-chevron-down"></i>
                <span class="toggle-text">Show All</span>
            </button>
        </div>
        <div class="card-body">
            <!-- Desktop Table View -->
            <div class="table-container desktop-view">
                <table class="budgets-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Period</th>
                            <th>Summary</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="budget-periods-list">
                        <tr>
                            <td colspan="6" class="loading">Loading budget periods...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile List View -->
            <div class="mobile-periods-container mobile-view" id="mobile-periods-container">
                <div class="mobile-periods-list" id="mobile-periods-list">
                    <div class="loading">Loading budget periods...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Cache-busting: v6.4-1735200000 - Force browser to reload JavaScript
// Global variables
let allPeriods = []; // Store all periods for filtering

// Show notification function
function showNotification(message, type = 'success') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// Toggle create budget form
function toggleCreateForm() {
    const createCard = document.getElementById('create-budget-card');
    const createBtn = document.querySelector('.create-budget-btn');
    
    if (createCard.style.display === 'none') {
        createCard.style.display = 'block';
        createBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
        createBtn.classList.remove('btn-primary');
        createBtn.classList.add('btn-secondary');
    } else {
        createCard.style.display = 'none';
        createBtn.innerHTML = '<i class="fas fa-plus"></i> Create Budget';
        createBtn.classList.remove('btn-secondary');
        createBtn.classList.add('btn-primary');
        // Reset form
        document.getElementById('create-budget-form').reset();
    }
}

// Format currency function
function formatCurrency(amount, currency = 'USD') {
    const symbol = getCurrencySymbol(currency);
    const formatter = new Intl.NumberFormat('en-US', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    return symbol + formatter.format(amount || 0);
}

// Get currency symbol
function getCurrencySymbol(currency) {
    const symbols = {
        'USD': '$',
        'EUR': '€',
        'GBP': '£',
        'ZAR': 'R',
        'CAD': 'C$',
        'AUD': 'A$',
        'BWP': 'P',
        'ZMW': 'K',
        'NGN': '₦',
        'KES': 'KSh',
        'GHS': '₵',
        'UGX': 'USh',
        'TZS': 'TSh',
        'ETB': 'Br',
        'RWF': 'RF',
        'MWK': 'MK',
        'BRL': 'R$',
        'MXN': '$',
        'PHP': '₱',
        'INR': '₹',
        'JPY': '¥'
    };
    return symbols[currency] || '$';
}

// Load user settings first
async function loadUserSettings() {
    try {
        const response = await authenticatedFetch('/api/user/settings');
        
        if (response.ok) {
            const settings = await response.json();
            userCurrency = settings.currency;
            document.dispatchEvent(new CustomEvent('currencyLoaded'));
        }
    } catch (error) {
        console.error('Error loading user settings:', error);
    }
}

// Load current active budget
async function loadCurrentBudget() {
    try {
        const response = await authenticatedFetch('/api/budget/budget');
        
        if (response.ok) {
            const budget = await response.json();
            if (budget.error) {
                throw new Error(budget.error);
            }
            // Budget loaded successfully - no need to display anything since we removed the current budget section
            return budget;
        } else if (response.status === 404) {
            // No budget found - this is expected when no budget exists
            return null;
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error loading current budget:', error);
        // Don't show error for 404 (no budget) cases
        if (!error.message.includes('404')) {
            showNotification('Error loading current budget: ' + error.message, 'error');
        }
        return null;
    }
}

// Load all budget periods
async function loadBudgetPeriods() {
    try {
        const response = await authenticatedFetch('/api/budget/budget-periods');
        
        if (response.ok) {
            const periods = await response.json();
            if (periods.error) {
                throw new Error(periods.error);
            }
            allPeriods = periods; // Store all periods for filtering
            renderBudgetPeriods(periods);
            
            // Hide loading state
            LoadingManager.hide('budgetsList');
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error loading budget periods:', error);
        document.getElementById('budget-periods-list').innerHTML = `<p>Error loading budget periods: ${error.message}</p>`;
        
        // Hide loading state even on error
        LoadingManager.hide('budgetsList');
    }
}

// Filter periods by type
function filterPeriodsByType(periodType) {
    if (periodType === 'all') {
        renderBudgetPeriods(allPeriods);
    } else {
        const filteredPeriods = allPeriods.filter(period => period.period_type === periodType);
        renderBudgetPeriods(filteredPeriods);
    }
}

// Render periods (extracted from loadBudgetPeriods)
function renderBudgetPeriods(periods) {
    const periodsList = document.getElementById('budget-periods-list');
    const mobilePeriodsList = document.getElementById('mobile-periods-list');
    
    if (periods.length === 0) {
        periodsList.innerHTML = '<tr><td colspan="6" class="no-data">No budget periods found. Create your first budget period above.</td></tr>';
        mobilePeriodsList.innerHTML = '<div class="no-data">No budget periods found. Create your first budget period above.</div>';
        return;
    }
    
    // Desktop table view
    periodsList.innerHTML = periods.map(period => `
        <tr class="budget-period-row ${period.is_active ? 'active' : ''}">
            <td class="period-name" data-label="Name">
                <div class="period-name-content">
                    <strong>${period.name}</strong>
                    ${period.is_active ? '<span class="active-indicator">CURRENT</span>' : ''}
                </div>
            </td>
            <td class="period-type" data-label="Type">
                <span class="type-badge ${period.period_type}">${period.period_type}</span>
            </td>
            <td class="period-dates" data-label="Period">
                ${period.start_date || 'N/A'} to ${period.end_date || 'N/A'}
            </td>
            <td class="period-summary" data-label="Summary">
                <div class="budget-summary-mini">
                    <div class="summary-item">
                        <span class="label">Income:</span>
                        <span class="amount">${formatCurrency(period.total_income, userCurrency)}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Spent:</span>
                        <span class="amount">${formatCurrency(period.total_spent, userCurrency)}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Balance:</span>
                        <span class="amount ${period.balance >= 0 ? 'positive' : 'negative'}">${formatCurrency(period.balance, userCurrency)}</span>
                    </div>
                </div>
            </td>
            <td class="period-status" data-label="Status">
                ${period.is_active ? 
                    '<span class="badge badge-success">Active</span>' : 
                    '<span class="badge badge-secondary">Inactive</span>'
                }
            </td>
            <td class="period-actions" data-label="Actions">
                <div class="action-buttons">
                    ${period.is_active ? 
                        '' : 
                        `<button class="btn btn-sm btn-primary" onclick="activateBudgetPeriod(${period.id})" title="Activate">
                            <i class="fas fa-play"></i>
                        </button>`
                    }
                    <button class="btn btn-sm btn-danger" onclick="deleteBudgetPeriod(${period.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    // Mobile list view
    mobilePeriodsList.innerHTML = periods.map(period => `
        <div class="mobile-period-item ${period.is_active ? 'active' : ''}">
            <div class="mobile-period-header" onclick="toggleMobilePeriodItem(${period.id})">
                <div class="mobile-period-title">
                    <h4>${period.name}</h4>
                    <span class="type-badge ${period.period_type}">${period.period_type}</span>
                    ${period.is_active ? '<span class="active-indicator">CURRENT</span>' : ''}
                </div>
                <div class="mobile-period-toggle">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="mobile-period-content" id="mobile-period-${period.id}">
                <div class="mobile-period-details">
                    <div class="detail-row">
                        <span class="label">Period:</span>
                        <span class="value">${period.start_date || 'N/A'} to ${period.end_date || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Status:</span>
                        <span class="value">
                            ${period.is_active ? 
                                '<span class="badge badge-success">Active</span>' : 
                                '<span class="badge badge-secondary">Inactive</span>'
                            }
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Income:</span>
                        <span class="value">${formatCurrency(period.total_income, userCurrency)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Spent:</span>
                        <span class="value">${formatCurrency(period.total_spent, userCurrency)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Balance:</span>
                        <span class="value ${period.balance >= 0 ? 'positive' : 'negative'}">${formatCurrency(period.balance, userCurrency)}</span>
                    </div>
                </div>
                <div class="mobile-period-actions">
                    ${period.is_active ? 
                        '' : 
                        `<button class="btn btn-sm btn-primary" onclick="activateBudgetPeriod(${period.id})" title="Activate">
                            <i class="fas fa-play"></i> Activate
                        </button>`
                    }
                    <button class="btn btn-sm btn-danger" onclick="deleteBudgetPeriod(${period.id})" title="Delete">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Activate a budget period
async function activateBudgetPeriod(periodId) {
    try {
        const response = await authenticatedFetch(`/api/budget/budget-periods/${periodId}/activate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            // Reload both current budget and periods list
            await loadCurrentBudget();
            await loadBudgetPeriods();
            showNotification('Budget period activated successfully!', 'success');
            
            // Dispatch event to notify other pages of budget period change
            document.dispatchEvent(new CustomEvent('budgetPeriodChanged'));
        } else {
            const error = await response.json();
            showNotification(error.message || 'Failed to activate budget period', 'error');
        }
    } catch (error) {
        console.error('Error activating budget period:', error);
        showNotification('Error activating budget period', 'error');
    }
}

// Delete a budget period
async function deleteBudgetPeriod(periodId) {
    // Find the period name for confirmation
    const period = allPeriods.find(p => p.id === periodId);
    if (!period) {
        showMessage('Budget period not found', 'error');
        return;
    }
    
    // Confirm deletion
    const confirmed = confirm(`Are you sure you want to delete "${period.name}"?\n\nThis will permanently delete:\n- The budget period\n- All budget allocations\n- All income sources\n- All other related data\n\nNote: Transactions will only be deleted if they don't belong to more specific budget periods (e.g., monthly transactions won't be deleted when deleting a quarterly period).\n\nThis action cannot be undone.`);
    
    if (!confirmed) {
        return;
    }
    
    try {
        const response = await authenticatedFetch(`/api/budget/budget-periods/${periodId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showNotification('Budget period and all related data deleted successfully!', 'success');
            
            // Reload the budget periods list
            await loadBudgetPeriods();
            await loadCurrentBudget();
            
            // Dispatch event to notify other pages of budget period change
            document.dispatchEvent(new CustomEvent('budgetPeriodChanged'));
        } else {
            const error = await response.json();
            showNotification(error.message || 'Failed to delete budget period', 'error');
        }
    } catch (error) {
        console.error('Error deleting budget period:', error);
        showNotification('Error deleting budget period', 'error');
    }
}

// Mobile toggle functions
function toggleMobilePeriods() {
    const container = document.getElementById('mobile-periods-container');
    const toggle = document.getElementById('mobile-periods-toggle');
    const icon = toggle.querySelector('i');
    const text = toggle.querySelector('.toggle-text');
    
    if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
        text.textContent = 'Hide All';
    } else {
        container.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
        text.textContent = 'Show All';
    }
}

function toggleMobilePeriodItem(periodId) {
    const content = document.getElementById(`mobile-period-${periodId}`);
    const header = content.previousElementSibling;
    const icon = header.querySelector('.mobile-period-toggle i');
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

// Handle form submission
document.getElementById('create-budget-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        name: formData.get('name'),
        period_type: formData.get('period_type'),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date')
    };
    
    try {
        const response = await authenticatedFetch('/api/budget/budget-periods', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const newPeriod = await response.json();
            showNotification('Budget period created successfully!', 'success');
            e.target.reset();
            
            // Reload the budget periods list
            await loadBudgetPeriods();
            await loadCurrentBudget();
            
            // Close the create form
            toggleCreateForm();
            
            // Dispatch event to notify other pages of budget period change
            document.dispatchEvent(new CustomEvent('budgetPeriodChanged'));
        } else {
            const error = await response.json();
            console.error('Error creating budget period:', error);
            showNotification(error.message || 'Failed to create budget period', 'error');
        }
    } catch (error) {
        console.error('Error creating budget period:', error);
        showNotification('Error creating budget period', 'error');
    }
});

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
    // Initialize loading states
    LoadingManager.show('budgetsList');
    
    const today = new Date();
    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('start-date').value = startOfMonth.toISOString().split('T')[0];
    document.getElementById('end-date').value = endOfMonth.toISOString().split('T')[0];
    
    // Load data
    loadUserSettings().then(() => {
        loadCurrentBudget();
        loadBudgetPeriods();
    });
    
    // Setup period type filter
    document.getElementById('periodTypeFilter').addEventListener('change', function() {
        filterPeriodsByType(this.value);
    });
});

// Auto-update dates based on period type
document.getElementById('period-type').addEventListener('change', function() {
    const periodType = this.value;
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const nameInput = document.getElementById('budget-name');
    
    const today = new Date();
    let startDate, endDate, name;
    
    switch (periodType) {
        case 'monthly':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            name = startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            break;
        case 'quarterly':
            const quarter = Math.floor(today.getMonth() / 3);
            startDate = new Date(today.getFullYear(), quarter * 3, 1);
            endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
            name = `Q${quarter + 1} ${today.getFullYear()}`;
            break;
        case 'yearly':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            name = today.getFullYear().toString();
            break;
        default:
            return; // Don't auto-fill for custom
    }
    
    startDateInput.value = startDate.toISOString().split('T')[0];
    endDateInput.value = endDate.toISOString().split('T')[0];
    nameInput.value = name;
});

</script>

{% endblock %}
