{% extends "base_admin.html" %}

{% block title %}Admin - Payments{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    <div style="margin-bottom: 30px;">
        <h1 style="margin: 0 0 10px 0;"><i class="fas fa-money-bill"></i> Payment Management</h1>
        <div style="margin-top: 15px;">
            <a href="/admin/dashboard" class="btn btn-outline">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px;">
        <h2>Payment Statistics</h2>
        <div id="paymentStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;"></div>
    </div>

    <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px;">
        <h2>All Payments</h2>
        <div id="paymentsTable" style="margin-top: 15px; overflow-x: auto;">
            <p>Loading...</p>
        </div>
    </div>
</div>

<script>
function getToken() {
    return getAdminToken();
}

async function loadPayments() {
    try {
        const response = await adminFetch('/api/subscriptions/admin/payments', {
            headers: {
                'Authorization': 'Bearer ' + getToken()
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.stats) {
            // Display stats
            const stats = data.stats;
            document.getElementById('paymentStats').innerHTML = `
                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>Total Payments:</strong> ${stats.total || 0}
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>Total Revenue:</strong> R${((stats.total_revenue_cents || 0) / 100).toFixed(2)}
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>By Status:</strong><br>
                    ${Object.keys(stats.by_status || {}).length > 0 
                        ? Object.entries(stats.by_status).map(([k, v]) => `${k}: ${v}`).join('<br>')
                        : 'No status data'}
                </div>
            `;
            
            // Display payments table
            if (!data.payments || data.payments.length === 0) {
                document.getElementById('paymentsTable').innerHTML = '<p>No payments found.</p>';
            } else {
                const table = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #ddd;">
                                <th style="padding: 10px; text-align: left;">ID</th>
                                <th style="padding: 10px; text-align: left;">User</th>
                                <th style="padding: 10px; text-align: left;">Amount</th>
                                <th style="padding: 10px; text-align: left;">Status</th>
                                <th style="padding: 10px; text-align: left;">Gateway Ref</th>
                                <th style="padding: 10px; text-align: left;">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.payments.map(p => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px;">${p.id}</td>
                                    <td style="padding: 10px;">${p.user_email || `User ${p.user_id}`}</td>
                                    <td style="padding: 10px;">${p.currency} ${(p.amount_cents / 100).toFixed(2)}</td>
                                    <td style="padding: 10px;"><span style="padding: 4px 8px; border-radius: 4px; background: ${p.status === 'paid' ? '#d4edda' : p.status === 'failed' ? '#f8d7da' : '#fff3cd'}; color: ${p.status === 'paid' ? '#155724' : p.status === 'failed' ? '#721c24' : '#856404'};">${p.status}</span></td>
                                    <td style="padding: 10px; font-size: 0.9em;">${p.gateway_reference || 'N/A'}</td>
                                    <td style="padding: 10px;">${new Date(p.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('paymentsTable').innerHTML = table;
            }
        } else {
            document.getElementById('paymentsTable').innerHTML = '<p>Error loading payments.</p>';
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('paymentsTable').innerHTML = '<p>Error loading payments.</p>';
    }
}

document.addEventListener('DOMContentLoaded', loadPayments);
</script>
{% endblock %}

