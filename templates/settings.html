{% extends "base.html" %}

{% block title %}Settings - STEWARD{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Settings</h1>
        <p class="page-subtitle">Manage your account preferences and currency settings.</p>
    </div>

    <!-- Settings Header with Quick Actions -->
    <div class="settings-header">
        <div class="header-left">
            <h2>Account & Preferences</h2>
            <p>Manage your account settings and preferences</p>
        </div>
        <div class="header-right">
            <button class="btn btn-secondary" onclick="togglePasswordForm()">
                <i class="fas fa-key"></i>
                Change Password
            </button>
        </div>
    </div>

    <!-- Main Settings Form -->
    <div class="card settings-card">
        <div class="card-body">
            <form id="mainSettingsForm" class="settings-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" readonly class="readonly-input">
                        <small class="form-help">Username cannot be changed</small>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="currency">Default Currency</label>
                        <select id="currency" name="currency" required>
                            <option value="USD">USD ($) - US Dollar</option>
                            <option value="EUR">EUR (€) - Euro</option>
                            <option value="GBP">GBP (£) - British Pound</option>
                            <option value="ZAR">ZAR (R) - South African Rand</option>
                            <option value="CAD">CAD (C$) - Canadian Dollar</option>
                            <option value="AUD">AUD (A$) - Australian Dollar</option>
                            <option value="BWP">BWP (P) - Botswana Pula</option>
                            <option value="ZMW">ZMW (K) - Zambian Kwacha</option>
                            <option value="NGN">NGN (₦) - Nigerian Naira</option>
                            <option value="KES">KES (KSh) - Kenyan Shilling</option>
                            <option value="GHS">GHS (₵) - Ghanaian Cedi</option>
                            <option value="UGX">UGX (USh) - Ugandan Shilling</option>
                            <option value="TZS">TZS (TSh) - Tanzanian Shilling</option>
                            <option value="ETB">ETB (Br) - Ethiopian Birr</option>
                            <option value="RWF">RWF (RF) - Rwandan Franc</option>
                            <option value="MWK">MWK (MK) - Malawian Kwacha</option>
                            <option value="BRL">BRL (R$) - Brazilian Real</option>
                            <option value="MXN">MXN ($) - Mexican Peso</option>
                            <option value="PHP">PHP (₱) - Philippine Peso</option>
                            <option value="INR">INR (₹) - Indian Rupee</option>
                            <option value="JPY">JPY (¥) - Japanese Yen</option>
                        </select>
                        <small class="form-help">Used for displaying all monetary values</small>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Save Settings
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Change Form (Collapsible) -->
    <div class="card password-card" id="passwordCard" style="display: none;">
        <div class="card-body">
            <div class="password-header">
                <h3>Change Password</h3>
                <button type="button" class="btn btn-secondary btn-sm" onclick="togglePasswordForm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="passwordForm" class="settings-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" name="current_password" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="new_password" required minlength="6">
                        <small class="form-help">Password must be at least 6 characters long</small>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" name="confirm_password" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-key"></i>
                        Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- App Information (Minimal) -->
    <div class="app-info-card">
        <div class="app-info-content">
            <div class="app-version">
                <span class="version-label">Wealth Wise v1.0.0</span>
            </div>
            <div class="app-inspiration">
                <p>"The plans of the diligent lead to profit as surely as haste leads to poverty."</p>
                <span class="verse-reference">- Proverbs 21:5</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show notification function
function showNotification(message, type = 'success') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    loadUserSettings();
    setupFormListeners();
});

// Toggle password form visibility
function togglePasswordForm() {
    const passwordCard = document.getElementById('passwordCard');
    const passwordBtn = document.querySelector('.settings-header .btn');
    
    if (passwordCard.style.display === 'none') {
        passwordCard.style.display = 'block';
        passwordBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
        passwordBtn.classList.remove('btn-secondary');
        passwordBtn.classList.add('btn-danger');
    } else {
        passwordCard.style.display = 'none';
        passwordBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
        passwordBtn.classList.remove('btn-danger');
        passwordBtn.classList.add('btn-secondary');
        // Reset password form
        document.getElementById('passwordForm').reset();
    }
}

function loadUserSettings() {
    fetch('/api/user/settings', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('username').value = data.username;
        document.getElementById('email').value = data.email;
        document.getElementById('currency').value = data.currency;
    })
    .catch(error => console.error('Error loading user settings:', error));
}

function setupFormListeners() {
    document.getElementById('mainSettingsForm').addEventListener('submit', handleMainSettingsUpdate);
    document.getElementById('passwordForm').addEventListener('submit', handlePasswordChange);
}

function handleMainSettingsUpdate(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        email: formData.get('email'),
        currency: formData.get('currency')
    };
    
    fetch('/api/user/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showNotification(data.message, 'success');
        } else {
            showNotification('Settings updated successfully!', 'success');
        }
        // Reload the page to update currency formatting
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        console.error('Error updating settings:', error);
        showNotification('Error updating settings. Please try again.', 'error');
    });
}

function handlePasswordChange(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword !== confirmPassword) {
        showNotification('New passwords do not match', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showNotification('Password must be at least 6 characters long', 'error');
        return;
    }
    
    const data = {
        current_password: formData.get('current_password'),
        new_password: newPassword
    };
    
    fetch('/api/user/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showNotification(data.message, 'success');
            e.target.reset();
        } else {
            showNotification('Password changed successfully!', 'success');
            e.target.reset();
        }
    })
    .catch(error => {
        console.error('Error changing password:', error);
        showNotification('Error changing password. Please try again.', 'error');
    });
}
</script>
{% endblock %}
