{% extends "base.html" %}

{% block title %}Settings - STEWARD{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-cog"></i> Settings</h1>
        <p>Manage your account preferences and application settings</p>
    </div>

    <div class="settings-grid">
        <!-- Account Settings -->
        <div class="settings-card">
            <div class="settings-card-header">
                <h2><i class="fas fa-user"></i> Account Settings</h2>
            </div>
            <div class="settings-card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Display Name</h3>
                        <p>Set how your name appears on the dashboard (defaults to first name)</p>
                    </div>
                    <button class="btn btn-outline" onclick="openDisplayNameModal()">
                        <i class="fas fa-edit"></i> Change Display Name
                    </button>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Email Address</h3>
                        <p>Update your email address for account notifications</p>
                    </div>
                    <button class="btn btn-outline" onclick="openEmailModal()">
                        <i class="fas fa-edit"></i> Change Email
                    </button>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Password</h3>
                        <p>Change your account password for security</p>
                    </div>
                    <button class="btn btn-outline" onclick="openPasswordModal()">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
            </div>
        </div>

        <!-- Application Settings -->
        <div class="settings-card">
            <div class="settings-card-header">
                <h2><i class="fas fa-cog"></i> Application Settings</h2>
            </div>
            <div class="settings-card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Default Currency</h3>
                        <p>Set your preferred currency for displaying monetary values</p>
                    </div>
                    <button class="btn btn-outline" onclick="openCurrencyModal()">
                        <i class="fas fa-dollar-sign"></i> Change Currency
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Management -->
        <div class="settings-card">
            <div class="settings-card-header">
                <h2><i class="fas fa-database"></i> Data Management</h2>
            </div>
            <div class="settings-card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Export Data</h3>
                        <p>Download your budget and transaction data</p>
                    </div>
                    <button class="btn btn-outline" onclick="exportData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Reset Data</h3>
                        <p>Clear all your budget and transaction data</p>
                    </div>
                    <button class="btn btn-danger" onclick="resetData()">
                        <i class="fas fa-trash"></i> Reset All Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Account Management -->
        <div class="settings-card danger-card">
            <div class="settings-card-header">
                <h2><i class="fas fa-user-times"></i> Account Management</h2>
            </div>
            <div class="settings-card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Delete Account</h3>
                        <p>Permanently delete your account and all associated data. This action cannot be undone.</p>
                        <div class="warning-text">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Warning:</strong> This will permanently delete your account, all budget data, transactions, and settings. This action cannot be reversed.
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="openDeleteAccountModal()">
                        <i class="fas fa-trash-alt"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>

        <!-- About -->
        <div class="settings-card">
            <div class="settings-card-header">
                <h2><i class="fas fa-info-circle"></i> About STEWARD</h2>
            </div>
            <div class="settings-card-body">
                <div class="about-content">
                    <p><strong>Version:</strong> 1.0.0</p>
                    <p><strong>Built with:</strong> Faith and love for Christian families</p>
                    <p class="verse">"The plans of the diligent lead to profit as surely as haste leads to poverty." - Proverbs 21:5</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Change Modal -->
<div class="modal" id="emailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-envelope"></i> Change Email Address</h3>
            <button class="modal-close" onclick="closeEmailModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="emailForm">
                <div class="form-group">
                    <label for="currentEmail">Current Email</label>
                    <input type="email" id="currentEmail" readonly value="user@example.com">
                </div>
                <div class="form-group">
                    <label for="newEmail">New Email Address</label>
                    <input type="email" id="newEmail" required placeholder="Enter new email address">
                </div>
                <div class="form-group">
                    <label for="confirmEmail">Confirm New Email</label>
                    <input type="email" id="confirmEmail" required placeholder="Confirm new email address">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEmailModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateEmail()">
                <i class="fas fa-save"></i> Update Email
            </button>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div class="modal" id="passwordModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-key"></i> Change Password</h3>
            <button class="modal-close" onclick="closePasswordModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 12px; margin-bottom: 20px; text-align: center;">
                <i class="fas fa-info-circle" style="color: #2196f3; margin-right: 8px;"></i>
                <strong style="color: #1976d2;">Create a strong password that meets all security requirements below</strong>
            </div>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" required placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" required placeholder="Enter new password (8+ chars, mixed case, numbers, symbols)">
                    <div class="password-requirements" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #8B4513; border-radius: 10px; padding: 15px; margin-top: 10px; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(139, 69, 19, 0.1);">
                        <div style="font-weight: 700; margin-bottom: 12px; color: #8B4513; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-shield-alt" style="color: #8B4513;"></i>
                            Password Requirements:
                        </div>
                        <ul style="margin: 0; padding-left: 20px; color: #495057; font-size: 0.85rem; line-height: 1.6;">
                            <li><strong>At least 8 characters long</strong></li>
                            <li><strong>At least one uppercase letter (A-Z)</strong></li>
                            <li><strong>At least one lowercase letter (a-z)</strong></li>
                            <li><strong>At least one number (0-9)</strong></li>
                            <li><strong>At least one special character (!@#$%^&*)</strong></li>
                        </ul>
                        <div style="margin-top: 12px; padding: 10px; background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%); border-radius: 6px; font-size: 0.8rem; color: white; text-align: center;">
                            <strong><i class="fas fa-lightbulb"></i> Example:</strong> MyPassword123!
                        </div>
                    </div>
                    <div class="password-strength" style="margin-top: 8px; font-size: 0.85rem;">
                        <div class="strength-bar" style="height: 4px; background: #e9ecef; border-radius: 2px; margin-top: 5px; overflow: hidden;">
                            <div class="strength-fill" id="settingsStrengthBar" style="height: 100%; transition: all 0.3s ease; border-radius: 2px;"></div>
                        </div>
                        <span id="settingsStrengthText" style="font-size: 0.8rem;">Enter a password</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" required placeholder="Confirm new password">
                    <div class="success-message" id="settingsPasswordMatch" style="display: none; color: #28a745; font-size: 0.85rem; margin-top: 5px;">
                        <i class="fas fa-check-circle"></i> Passwords match
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updatePassword()">
                <i class="fas fa-save"></i> Update Password
            </button>
        </div>
    </div>
</div>

<!-- Display Name Change Modal -->
<div class="modal" id="displayNameModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user"></i> Change Display Name</h3>
            <button class="modal-close" onclick="closeDisplayNameModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 12px; margin-bottom: 20px; text-align: center;">
                <i class="fas fa-info-circle" style="color: #4caf50; margin-right: 8px;"></i>
                <strong style="color: #2e7d32;">Set how your name appears on the dashboard</strong>
            </div>
            <form id="displayNameForm">
                <div class="form-group">
                    <label for="displayName">Display Name</label>
                    <input type="text" id="displayName" placeholder="Enter your preferred display name (leave empty to use first name)">
                    <small style="color: #6c757d; font-size: 0.8rem; margin-top: 5px; display: block;">
                        Leave empty to use your first name as the default display name
                    </small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDisplayNameModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateDisplayName()">
                <i class="fas fa-save"></i> Update Display Name
            </button>
        </div>
    </div>
</div>

<!-- Currency Change Modal -->
<div class="modal" id="currencyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-dollar-sign"></i> Change Currency</h3>
            <button class="modal-close" onclick="closeCurrencyModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="currencyForm">
                <div class="form-group">
                    <label for="currencySelect">Select Currency</label>
                    <select id="currencySelect" required>
                        <option value="USD">USD - US Dollar ($)</option>
                        <option value="EUR">EUR - Euro (€)</option>
                        <option value="GBP">GBP - British Pound (£)</option>
                        <option value="ZAR">ZAR - South African Rand (R)</option>
                        <option value="CAD">CAD - Canadian Dollar (C$)</option>
                        <option value="AUD">AUD - Australian Dollar (A$)</option>
                        <option value="BWP">BWP - Botswana Pula (P)</option>
                        <option value="ZMW">ZMW - Zambian Kwacha (K)</option>
                        <option value="NGN">NGN - Nigerian Naira (₦)</option>
                        <option value="KES">KES - Kenyan Shilling (KSh)</option>
                        <option value="GHS">GHS - Ghanaian Cedi (₵)</option>
                        <option value="UGX">UGX - Ugandan Shilling (USh)</option>
                        <option value="TZS">TZS - Tanzanian Shilling (TSh)</option>
                        <option value="ETB">ETB - Ethiopian Birr (Br)</option>
                        <option value="RWF">RWF - Rwandan Franc (RF)</option>
                        <option value="MWK">MWK - Malawian Kwacha (MK)</option>
                        <option value="BRL">BRL - Brazilian Real (R$)</option>
                        <option value="MXN">MXN - Mexican Peso ($)</option>
                        <option value="PHP">PHP - Philippine Peso (₱)</option>
                        <option value="INR">INR - Indian Rupee (₹)</option>
                        <option value="JPY">JPY - Japanese Yen (¥)</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCurrencyModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateCurrency()">
                <i class="fas fa-save"></i> Update Currency
            </button>
        </div>
    </div>
</div>

<!-- Reset Data Confirmation Modal -->
<div class="modal" id="resetDataModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Reset All Data</h3>
            <button class="modal-close" onclick="closeResetModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="warning-message">
                <p><strong>Warning:</strong> This action cannot be undone!</p>
                <p>This will permanently delete:</p>
                <ul>
                    <li>All your transactions</li>
                    <li>All your budget periods and allocations</li>
                    <li>All your income sources</li>
                    <li>All your custom categories and subcategories</li>
                </ul>
                <p>Your account settings (email, password, currency) will be preserved.</p>
            </div>
            <div class="form-group">
                <label for="confirmReset">Type "RESET" to confirm:</label>
                <input type="text" id="confirmReset" placeholder="Type RESET here">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeResetModal()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmResetData()" id="confirmResetBtn" disabled>
                <i class="fas fa-trash"></i> Reset All Data
            </button>
        </div>
    </div>
</div>

<!-- Delete Account Confirmation Modal -->
<div class="modal" id="deleteAccountModal">
    <div class="modal-content">
        <div class="modal-header danger-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Delete Account</h3>
            <button class="modal-close" onclick="closeDeleteAccountModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="danger-message">
                <div class="danger-icon">
                    <i class="fas fa-skull-crossbones"></i>
                </div>
                <h4>This action is PERMANENT and CANNOT be undone!</h4>
                <p>Deleting your account will permanently remove:</p>
                <ul>
                    <li><strong>Your entire account</strong> - username, email, password</li>
                    <li><strong>All budget data</strong> - periods, allocations, categories</li>
                    <li><strong>All transactions</strong> - income, expenses, transfers</li>
                    <li><strong>All settings</strong> - currency, preferences, configurations</li>
                    <li><strong>All historical data</strong> - reports, analytics, insights</li>
                </ul>
                <div class="final-warning">
                    <p><strong>⚠️ FINAL WARNING:</strong> Once you delete your account, there is no way to recover any of your data. This action is irreversible.</p>
                </div>
            </div>
            <div class="form-group">
                <label for="confirmDelete">Type "DELETE MY ACCOUNT" to confirm:</label>
                <input type="text" id="confirmDelete" placeholder="Type DELETE MY ACCOUNT here">
                <small class="form-help">This is case-sensitive and must match exactly</small>
            </div>
            <div class="form-group">
                <label for="deletePassword">Enter your current password:</label>
                <input type="password" id="deletePassword" placeholder="Enter your current password">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteAccountModal()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()" id="confirmDeleteBtn" disabled>
                <i class="fas fa-trash-alt"></i> Permanently Delete Account
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Modal functions
function openEmailModal() {
    document.getElementById('emailModal').style.display = 'block';
    document.body.classList.add('modal-open');
}

function closeEmailModal() {
    document.getElementById('emailModal').style.display = 'none';
    document.getElementById('emailForm').reset();
    document.body.classList.remove('modal-open');
}

function openPasswordModal() {
    document.getElementById('passwordModal').style.display = 'block';
    document.body.classList.add('modal-open');
}

function closePasswordModal() {
    document.getElementById('passwordModal').style.display = 'none';
    document.getElementById('passwordForm').reset();
    document.body.classList.remove('modal-open');
}

function openDisplayNameModal() {
    // Load current display name
    loadUserSettings().then(settings => {
        document.getElementById('displayName').value = settings.display_name || '';
        document.getElementById('displayNameModal').style.display = 'block';
        document.body.classList.add('modal-open');
    });
}

function closeDisplayNameModal() {
    document.getElementById('displayNameModal').style.display = 'none';
    document.getElementById('displayNameForm').reset();
    document.body.classList.remove('modal-open');
}

function openCurrencyModal() {
    document.getElementById('currencyModal').style.display = 'block';
    document.body.classList.add('modal-open');
}

function closeCurrencyModal() {
    document.getElementById('currencyModal').style.display = 'none';
    document.getElementById('currencyForm').reset();
    document.body.classList.remove('modal-open');
}

// Update functions
function updateEmail() {
    const newEmail = document.getElementById('newEmail').value;
    const confirmEmail = document.getElementById('confirmEmail').value;
    
    if (newEmail !== confirmEmail) {
        showNotification('Email addresses do not match', 'error');
        return;
    }
    
    if (!newEmail || !confirmEmail) {
        showNotification('Please fill in all fields', 'error');
        return;
    }
    
    const data = {
        email: newEmail
    };
    
    fetch('/api/user/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        showNotification('Email updated successfully!', 'success');
        closeEmailModal();
        // Reload the page to update the display
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        console.error('Error updating email:', error);
        showNotification('Error updating email. Please try again.', 'error');
    });
}

function updatePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showNotification('Please fill in all fields', 'error');
        return;
    }
    
    if (!validatePassword(newPassword)) {
        showNotification('Password must be at least 8 characters long and contain uppercase letters, lowercase letters, numbers, and special characters.', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    // Make API call to update password
    fetch('/api/user/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
        })
    })
    .then(response => {
        return response.json().then(data => ({
            ok: response.ok,
            data: data
        }));
    })
    .then(result => {
        if (result.ok) {
            showNotification('Password updated successfully!', 'success');
            closePasswordModal();
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        } else {
            showNotification(result.data.message || 'Failed to update password', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating password:', error);
        showNotification('An error occurred while updating password', 'error');
    });
}

function updateDisplayName() {
    const displayName = document.getElementById('displayName').value.trim();
    
    // Make API call to update display name
    fetch('/api/user/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
            display_name: displayName
        })
    })
    .then(response => {
        return response.json().then(data => ({
            ok: response.ok,
            data: data
        }));
    })
    .then(result => {
        if (result.ok) {
            showNotification('Display name updated successfully!', 'success');
            closeDisplayNameModal();
            // Refresh dashboard to show new display name
            if (window.location.pathname === '/dashboard') {
                loadUserInfo();
            }
        } else {
            showNotification(result.data.message || 'Failed to update display name', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating display name:', error);
        showNotification('An error occurred while updating display name', 'error');
    });
}

// Password strength validation for settings
function updateSettingsPasswordStrength() {
    const password = document.getElementById('newPassword').value;
    const strengthBar = document.getElementById('settingsStrengthBar');
    const strengthText = document.getElementById('settingsStrengthText');
    
    if (password.length === 0) {
        strengthBar.className = 'strength-fill';
        strengthText.textContent = 'Enter a password';
        strengthText.style.color = '#6c757d';
        return;
    }
    
    const { score } = checkPasswordStrength(password);
    
    // Update strength bar
    strengthBar.className = 'strength-fill';
    strengthBar.classList.add(getPasswordStrengthClass(score));
    
    // Update strength text
    strengthText.textContent = getPasswordStrengthText(score);
    
    // Update text color
    if (score <= 1) {
        strengthText.style.color = '#dc3545';
    } else if (score <= 2) {
        strengthText.style.color = '#ffc107';
    } else if (score <= 3) {
        strengthText.style.color = '#17a2b8';
    } else {
        strengthText.style.color = '#28a745';
    }
    
    // Check password match
    checkSettingsPasswordMatch();
}

function checkSettingsPasswordMatch() {
    const password = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const matchDiv = document.getElementById('settingsPasswordMatch');
    
    if (confirmPassword.length === 0) {
        matchDiv.style.display = 'none';
        return;
    }
    
    if (password === confirmPassword) {
        matchDiv.style.display = 'flex';
    } else {
        matchDiv.style.display = 'none';
    }
}

// Get JWT token from localStorage
function getToken() {
    return localStorage.getItem('token');
}

// Add event listeners when the page loads
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    
    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', updateSettingsPasswordStrength);
    }
    
    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', checkSettingsPasswordMatch);
    }
});

function updateCurrency() {
    const currency = document.getElementById('currencySelect').value;
    
    if (!currency) {
        showNotification('Please select a currency', 'error');
        return;
    }
    
    const data = {
        currency: currency
    };
    
    fetch('/api/user/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        showNotification('Currency updated successfully!', 'success');
        closeCurrencyModal();
        // Reload the page to update currency formatting
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        console.error('Error updating currency:', error);
        showNotification('Error updating currency. Please try again.', 'error');
    });
}

// Export data functionality
function exportData() {
    showNotification('Preparing Excel export...', 'info');
    
    fetch('/api/user/export-data', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Export failed');
        }
        return response.blob();
    })
    .then(blob => {
        // Create and download Excel file
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `steward-export-${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showNotification('Excel file exported successfully!', 'success');
    })
    .catch(error => {
        console.error('Error exporting data:', error);
        showNotification('Error exporting data. Please try again.', 'error');
    });
}

// Reset data functionality
function resetData() {
    document.getElementById('resetDataModal').style.display = 'block';
    document.body.classList.add('modal-open');
}

function closeResetModal() {
    document.getElementById('resetDataModal').style.display = 'none';
    document.getElementById('confirmReset').value = '';
    document.getElementById('confirmResetBtn').disabled = true;
    document.body.classList.remove('modal-open');
}

// Enable reset button only when "RESET" is typed
document.addEventListener('DOMContentLoaded', function() {
    const confirmInput = document.getElementById('confirmReset');
    const confirmBtn = document.getElementById('confirmResetBtn');
    
    if (confirmInput && confirmBtn) {
        confirmInput.addEventListener('input', function() {
            confirmBtn.disabled = this.value !== 'RESET';
        });
    }
});

function confirmResetData() {
    const confirmInput = document.getElementById('confirmReset');
    if (confirmInput.value !== 'RESET') {
        showNotification('Please type "RESET" to confirm', 'error');
        return;
    }
    
    if (confirm('Are you absolutely sure you want to reset all data? This cannot be undone!')) {
        // Show loading state
        const resetBtn = document.getElementById('confirmResetBtn');
        const originalText = resetBtn.innerHTML;
        resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
        resetBtn.disabled = true;
        
        // Call API to reset data
        fetch('/api/user/reset-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            }
        })
        .then(response => {
            console.log('Reset response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Reset data response:', data);
            if (data.message) {
                showNotification(data.message, 'success');
                closeResetModal();
                // Redirect to dashboard after reset
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            } else {
                showNotification('Data reset successfully!', 'success');
                closeResetModal();
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error resetting data:', error);
            showNotification('Error resetting data. Please try again.', 'error');
            // Reset button state
            resetBtn.innerHTML = originalText;
            resetBtn.disabled = false;
            // Don't close modal on error so user can try again
        });
    }
}

// Delete Account Functions
function openDeleteAccountModal() {
    document.getElementById('deleteAccountModal').style.display = 'block';
    document.body.classList.add('modal-open');
    // Clear form
    document.getElementById('confirmDelete').value = '';
    document.getElementById('deletePassword').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
}

function closeDeleteAccountModal() {
    document.getElementById('deleteAccountModal').style.display = 'none';
    document.body.classList.remove('modal-open');
    // Clear form
    document.getElementById('confirmDelete').value = '';
    document.getElementById('deletePassword').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
}

// Enable/disable delete button based on confirmation text
document.addEventListener('DOMContentLoaded', function() {
    const confirmInput = document.getElementById('confirmDelete');
    const deleteBtn = document.getElementById('confirmDeleteBtn');
    
    if (confirmInput && deleteBtn) {
        confirmInput.addEventListener('input', function() {
            const passwordInput = document.getElementById('deletePassword');
            const isConfirmed = this.value === 'DELETE MY ACCOUNT';
            const hasPassword = passwordInput.value.length > 0;
            
            deleteBtn.disabled = !(isConfirmed && hasPassword);
        });
        
        const passwordInput = document.getElementById('deletePassword');
        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                const isConfirmed = confirmInput.value === 'DELETE MY ACCOUNT';
                const hasPassword = this.value.length > 0;
                
                deleteBtn.disabled = !(isConfirmed && hasPassword);
            });
        }
    }
});

function confirmDeleteAccount() {
    const confirmInput = document.getElementById('confirmDelete');
    const passwordInput = document.getElementById('deletePassword');
    
    if (confirmInput.value !== 'DELETE MY ACCOUNT') {
        showNotification('Please type "DELETE MY ACCOUNT" exactly to confirm', 'error');
        return;
    }
    
    if (!passwordInput.value) {
        showNotification('Please enter your current password', 'error');
        return;
    }
    
    if (confirm('⚠️ FINAL CONFIRMATION ⚠️\n\nAre you absolutely certain you want to permanently delete your account?\n\nThis action CANNOT be undone and will permanently remove ALL your data.\n\nType "YES" in the next prompt to proceed.')) {
        const finalConfirm = prompt('Type "YES" to permanently delete your account:');
        if (finalConfirm === 'YES') {
            // Show loading state
            const deleteBtn = document.getElementById('confirmDeleteBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting Account...';
            deleteBtn.disabled = true;
            
            // Call API to delete account
            fetch('/api/user/delete-account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getToken()
                },
                body: JSON.stringify({
                    password: passwordInput.value
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                showNotification('Account deleted successfully. You will be redirected to the home page.', 'success');
                closeDeleteAccountModal();
                // Clear token and redirect
                localStorage.removeItem('token');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            })
            .catch(error => {
                console.error('Error deleting account:', error);
                showNotification('Error deleting account. Please check your password and try again.', 'error');
                // Reset button state
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            });
        }
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = ['resetDataModal', 'emailModal', 'passwordModal', 'currencyModal', 'deleteAccountModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
            switch(modalId) {
                case 'resetDataModal':
                    closeResetModal();
                    break;
                case 'emailModal':
                    closeEmailModal();
                    break;
                case 'passwordModal':
                    closePasswordModal();
                    break;
                case 'currencyModal':
                    closeCurrencyModal();
                    break;
                case 'deleteAccountModal':
                    closeDeleteAccountModal();
                    break;
            }
        }
    });
}
</script>
{% endblock %}
