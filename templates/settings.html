{% extends "base.html" %}

{% block title %}Settings - STEWARD{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Settings</h1>
        <p class="page-subtitle">Manage your account preferences and currency settings.</p>
    </div>

    <div class="settings-container">
        <!-- Account Settings -->
        <div class="card">
            <div class="card-header">
                <h2>Account Settings</h2>
            </div>
            <div class="card-body">
                <form id="accountForm" class="settings-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" readonly>
                        <small class="form-help">Username cannot be changed</small>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Save Account Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Currency Settings -->
        <div class="card">
            <div class="card-header">
                <h2>Currency Settings</h2>
            </div>
            <div class="card-body">
                <form id="currencyForm" class="settings-form">
                    <div class="form-group">
                        <label for="currency">Default Currency</label>
                        <select id="currency" name="currency" required>
                            <option value="USD">USD ($) - US Dollar</option>
                            <option value="EUR">EUR (€) - Euro</option>
                            <option value="GBP">GBP (£) - British Pound</option>
                            <option value="ZAR">ZAR (R) - South African Rand</option>
                            <option value="CAD">CAD (C$) - Canadian Dollar</option>
                            <option value="AUD">AUD (A$) - Australian Dollar</option>
                            <option value="JPY">JPY (¥) - Japanese Yen</option>
                        </select>
                        <small class="form-help">This will be used for displaying all monetary values</small>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Save Currency Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Password Change -->
        <div class="card">
            <div class="card-header">
                <h2>Change Password</h2>
            </div>
            <div class="card-body">
                <form id="passwordForm" class="settings-form">
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" name="current_password" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="new_password" required minlength="6">
                        <small class="form-help">Password must be at least 6 characters long</small>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" name="confirm_password" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-key"></i>
                            Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- App Information -->
        <div class="card">
            <div class="card-header">
                <h2>About Wealth Wise</h2>
            </div>
            <div class="card-body">
                <div class="app-info">
                    <div class="info-item">
                        <span class="info-label">Version:</span>
                        <span class="info-value">1.0.0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Built with:</span>
                        <span class="info-value">Faith and love for Christian families</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Inspiration:</span>
                        <span class="info-value">"The plans of the diligent lead to profit as surely as haste leads to poverty." - Proverbs 21:5</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadUserSettings();
    setupFormListeners();
});

function loadUserSettings() {
    fetch('/api/user/settings', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('username').value = data.username;
        document.getElementById('email').value = data.email;
        document.getElementById('currency').value = data.currency;
    })
    .catch(error => console.error('Error loading user settings:', error));
}

function setupFormListeners() {
    document.getElementById('accountForm').addEventListener('submit', handleAccountUpdate);
    document.getElementById('currencyForm').addEventListener('submit', handleCurrencyUpdate);
    document.getElementById('passwordForm').addEventListener('submit', handlePasswordChange);
}

function handleAccountUpdate(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        email: formData.get('email')
    };
    
    fetch('/api/user/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showNotification(data.message, 'success');
        } else {
            showNotification('Account settings updated successfully!', 'success');
        }
    })
    .catch(error => {
        console.error('Error updating account settings:', error);
        showNotification('Error updating account settings. Please try again.', 'error');
    });
}

function handleCurrencyUpdate(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        currency: formData.get('currency')
    };
    
    fetch('/api/user/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        showNotification('Currency settings updated successfully!', 'success');
        // Reload the page to update currency formatting
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        console.error('Error updating currency settings:', error);
        showNotification('Error updating currency settings. Please try again.', 'error');
    });
}

function handlePasswordChange(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword !== confirmPassword) {
        showNotification('New passwords do not match', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showNotification('Password must be at least 6 characters long', 'error');
        return;
    }
    
    const data = {
        current_password: formData.get('current_password'),
        new_password: newPassword
    };
    
    fetch('/api/user/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showNotification(data.message, 'success');
            e.target.reset();
        } else {
            showNotification('Password changed successfully!', 'success');
            e.target.reset();
        }
    })
    .catch(error => {
        console.error('Error changing password:', error);
        showNotification('Error changing password. Please try again.', 'error');
    });
}
</script>
{% endblock %}
