{% extends "base.html" %}

{% block title %}Settings - STEWARD{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-cog"></i> Settings</h1>
        <p>Manage your account preferences and application settings</p>
    </div>

    <div class="settings-grid">
        <!-- Account Settings -->
        <div class="settings-card">
            <div class="settings-card-header">
                <h2><i class="fas fa-user"></i> Account Settings</h2>
            </div>
            <div class="settings-card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Display Name</h3>
                        <p>Set how your name appears on the dashboard (defaults to first name)</p>
                    </div>
                    <button class="btn btn-outline" onclick="openDisplayNameModal()">
                        <i class="fas fa-edit"></i> Change Display Name
                    </button>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Password</h3>
                        <p>Change your account password for security</p>
                    </div>
                    <button class="btn btn-outline" onclick="openPasswordModal()">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
            </div>
        </div>

        <!-- Application Settings -->
        <div class="settings-card">
            <div class="settings-card-header">
                <h2><i class="fas fa-cog"></i> Application Settings</h2>
            </div>
            <div class="settings-card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Default Currency</h3>
                        <p>Set your preferred currency for displaying monetary values</p>
                    </div>
                    <button class="btn btn-outline" onclick="openCurrencyModal()">
                        <i class="fas fa-dollar-sign"></i> Change Currency
                    </button>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Theme</h3>
                        <p>Choose between light and dark mode for the application interface</p>
                    </div>
                    <div class="theme-selector">
                        <button class="theme-btn" data-theme="light" onclick="setTheme('light')">
                            <i class="fas fa-sun"></i> Light
                        </button>
                        <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">
                            <i class="fas fa-moon"></i> Dark
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription Management -->
        <div class="settings-card" id="subscriptionCard">
            <div class="settings-card-header">
                <h2><i class="fas fa-credit-card"></i> Subscription & Billing</h2>
            </div>
            <div class="settings-card-body">
                <div id="subscriptionStatus">
                    <div class="subscription-info" style="margin-bottom: 20px;">
                        <div id="subscriptionStatusBadge" class="status-badge" style="display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: bold; margin-bottom: 15px;">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                        <div id="subscriptionDetails" style="margin-top: 10px;">
                            <p id="subscriptionPlan">Plan: Loading...</p>
                            <p id="subscriptionTrial">Trial: Loading...</p>
                            <p id="subscriptionNextBilling" style="display: none;">Next Billing: Loading...</p>
                        </div>
                    </div>
                    
                    <div id="subscriptionActions" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="upgradeBtn" onclick="openUpgradeModal()" style="display: none;">
                            <i class="fas fa-arrow-up"></i> Upgrade Subscription
                        </button>
                        <button class="btn btn-outline" id="viewPlansBtn" onclick="openPlansModal()">
                            <i class="fas fa-list"></i> View Plans
                        </button>
                        <button class="btn btn-outline" id="viewPaymentsBtn" onclick="openPaymentsModal()">
                            <i class="fas fa-history"></i> Payment History
                        </button>
                        <button class="btn btn-danger" id="cancelBtn" onclick="openCancelModal()" style="display: none;">
                            <i class="fas fa-times"></i> Cancel Subscription
                        </button>
                        <button class="btn btn-outline" id="pauseBtn" onclick="pauseSubscription()" style="display: none;">
                            <i class="fas fa-pause"></i> Pause Subscription
                        </button>
                        <button class="btn btn-outline" id="resumeBtn" onclick="resumeSubscription()" style="display: none;">
                            <i class="fas fa-play"></i> Resume Subscription
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Management -->
        <div class="settings-card">
            <div class="settings-card-header">
                <h2><i class="fas fa-database"></i> Data Management</h2>
            </div>
            <div class="settings-card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Export Data</h3>
                        <p>Download your budget and transaction data</p>
                    </div>
                    <button class="btn btn-outline" onclick="exportData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Reset Data</h3>
                        <p>Clear all your budget and transaction data</p>
                    </div>
                    <button class="btn btn-danger" onclick="resetData()">
                        <i class="fas fa-trash"></i> Reset All Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Account Management -->
        <div class="settings-card danger-card">
            <div class="settings-card-header">
                <h2><i class="fas fa-user-times"></i> Account Management</h2>
            </div>
            <div class="settings-card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Delete Account</h3>
                        <p>Permanently delete your account and all associated data. This action cannot be undone.</p>
                        <div class="warning-text">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Warning:</strong> This will permanently delete your account, all budget data, transactions, and settings. This action cannot be reversed.
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="openDeleteAccountModal()">
                        <i class="fas fa-trash-alt"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>

        <!-- About -->
        <div class="settings-card">
            <div class="settings-card-header">
                <h2><i class="fas fa-info-circle"></i> About STEWARD</h2>
            </div>
            <div class="settings-card-body">
                <div class="about-content">
                    <p><strong>Version:</strong> 1.0.0</p>
                    <p><strong>Built with:</strong> Faith and love for Christian families</p>
                    <p class="verse">"The plans of the diligent lead to profit as surely as haste leads to poverty." - Proverbs 21:5</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div class="modal" id="passwordModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-key"></i> Change Password</h3>
            <button class="modal-close" onclick="closePasswordModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 12px; margin-bottom: 20px; text-align: center;">
                <i class="fas fa-info-circle" style="color: #2196f3; margin-right: 8px;"></i>
                <strong style="color: #1976d2;">Create a strong password that meets all security requirements below</strong>
            </div>
            <form id="settingsPasswordForm">
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" required placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" required placeholder="Enter new password (12+ chars, mixed case, numbers, symbols)">
                    <div class="password-requirements" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #8B4513; border-radius: 10px; padding: 15px; margin-top: 10px; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(139, 69, 19, 0.1);">
                        <div style="font-weight: 700; margin-bottom: 12px; color: #8B4513; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-shield-alt" style="color: #8B4513;"></i>
                            Password Requirements:
                        </div>
                        <ul style="margin: 0; padding-left: 0; color: #495057; font-size: 0.85rem; line-height: 1.6; list-style: none;">
                            <li id="req-length" style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-times-circle" style="color: #dc3545;"></i>
                                <strong>At least 12 characters long</strong>
                            </li>
                            <li id="req-uppercase" style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-times-circle" style="color: #dc3545;"></i>
                                <strong>At least one uppercase letter (A-Z)</strong>
                            </li>
                            <li id="req-lowercase" style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-times-circle" style="color: #dc3545;"></i>
                                <strong>At least one lowercase letter (a-z)</strong>
                            </li>
                            <li id="req-number" style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-times-circle" style="color: #dc3545;"></i>
                                <strong>At least one number (0-9)</strong>
                            </li>
                            <li id="req-special" style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-times-circle" style="color: #dc3545;"></i>
                                <strong>At least one special character (!@#$%^&*)</strong>
                            </li>
                        </ul>
                        <div style="margin-top: 12px; padding: 10px; background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%); border-radius: 6px; font-size: 0.8rem; color: white; text-align: center;">
                            <strong><i class="fas fa-lightbulb"></i> Example:</strong> MyPassword123!
                        </div>
                    </div>
                    <div class="password-strength" style="margin-top: 8px; font-size: 0.85rem;">
                        <div class="strength-bar" style="height: 4px; background: #e9ecef; border-radius: 2px; margin-top: 5px; overflow: hidden;">
                            <div class="strength-fill" id="settingsStrengthBar" style="height: 100%; transition: all 0.3s ease; border-radius: 2px;"></div>
                        </div>
                        <span id="settingsStrengthText" style="font-size: 0.8rem;">Enter a password</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" required placeholder="Confirm new password">
                    <div class="success-message" id="settingsPasswordMatch" style="display: none; color: #28a745; font-size: 0.85rem; margin-top: 5px;">
                        <i class="fas fa-check-circle"></i> Passwords match
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updatePassword()">
                <i class="fas fa-save"></i> Update Password
            </button>
        </div>
    </div>
</div>

<!-- Display Name Change Modal -->
<div class="modal" id="displayNameModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user"></i> Change Display Name</h3>
            <button class="modal-close" onclick="closeDisplayNameModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 12px; margin-bottom: 20px; text-align: center;">
                <i class="fas fa-info-circle" style="color: #4caf50; margin-right: 8px;"></i>
                <strong style="color: #2e7d32;">Set how your name appears on the dashboard</strong>
            </div>
            <form id="displayNameForm">
                <div class="form-group">
                    <label for="displayName">Display Name</label>
                    <input type="text" id="displayName" placeholder="Enter your preferred display name (leave empty to use first name)">
                    <small style="color: #6c757d; font-size: 0.8rem; margin-top: 5px; display: block;">
                        Leave empty to use your first name as the default display name
                    </small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDisplayNameModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateDisplayName()">
                <i class="fas fa-save"></i> Update Display Name
            </button>
        </div>
    </div>
</div>

<!-- Currency Change Modal -->
<div class="modal" id="currencyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-dollar-sign"></i> Change Currency</h3>
            <button class="modal-close" onclick="closeCurrencyModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="settingsCurrencyForm">
                <div class="form-group">
                    <label for="currencySelect">Select Currency</label>
                    <select id="currencySelect" required>
                        <option value="USD">USD - US Dollar ($)</option>
                        <option value="EUR">EUR - Euro (€)</option>
                        <option value="GBP">GBP - British Pound (£)</option>
                        <option value="ZAR">ZAR - South African Rand (R)</option>
                        <option value="CAD">CAD - Canadian Dollar (C$)</option>
                        <option value="AUD">AUD - Australian Dollar (A$)</option>
                        <option value="BWP">BWP - Botswana Pula (P)</option>
                        <option value="ZMW">ZMW - Zambian Kwacha (K)</option>
                        <option value="NGN">NGN - Nigerian Naira (₦)</option>
                        <option value="KES">KES - Kenyan Shilling (KSh)</option>
                        <option value="GHS">GHS - Ghanaian Cedi (₵)</option>
                        <option value="UGX">UGX - Ugandan Shilling (USh)</option>
                        <option value="TZS">TZS - Tanzanian Shilling (TSh)</option>
                        <option value="ETB">ETB - Ethiopian Birr (Br)</option>
                        <option value="RWF">RWF - Rwandan Franc (RF)</option>
                        <option value="MWK">MWK - Malawian Kwacha (MK)</option>
                        <option value="BRL">BRL - Brazilian Real (R$)</option>
                        <option value="MXN">MXN - Mexican Peso ($)</option>
                        <option value="PHP">PHP - Philippine Peso (₱)</option>
                        <option value="INR">INR - Indian Rupee (₹)</option>
                        <option value="JPY">JPY - Japanese Yen (¥)</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCurrencyModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateCurrency()">
                <i class="fas fa-save"></i> Update Currency
            </button>
        </div>
    </div>
</div>

<!-- Reset Data Confirmation Modal -->
<div class="modal" id="resetDataModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Reset All Data</h3>
            <button class="modal-close" onclick="closeResetModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="warning-message">
                <p><strong>Warning:</strong> This action cannot be undone!</p>
                <p>This will permanently delete:</p>
                <ul>
                    <li>All your transactions</li>
                    <li>All your budget periods and allocations</li>
                    <li>All your income sources</li>
                    <li>All your custom categories and subcategories</li>
                </ul>
                <p>Your account settings (email, password, currency) will be preserved.</p>
            </div>
            <div class="form-group">
                <label for="confirmReset">Type "RESET" to confirm:</label>
                <input type="text" id="confirmReset" placeholder="Type RESET here">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeResetModal()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmResetData()" id="confirmResetBtn" disabled>
                <i class="fas fa-trash"></i> Reset All Data
            </button>
        </div>
    </div>
</div>

<!-- Subscription Plans Modal -->
<div class="modal" id="plansModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-list"></i> Available Plans</h3>
            <button class="modal-close" onclick="closePlansModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="plansList"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePlansModal()">Close</button>
        </div>
    </div>
</div>

<!-- Payment History Modal -->
<div class="modal" id="paymentsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-history"></i> Payment History</h3>
            <button class="modal-close" onclick="closePaymentsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="paymentsList"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePaymentsModal()">Close</button>
        </div>
    </div>
</div>

<!-- Cancel Subscription Modal -->
<div class="modal" id="cancelSubscriptionModal">
    <div class="modal-content">
        <div class="modal-header danger-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Cancel Subscription</h3>
            <button class="modal-close" onclick="closeCancelModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="warning-message">
                <p>Are you sure you want to cancel your subscription?</p>
                <p>You can choose to cancel immediately or at the end of your current billing period.</p>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="cancelImmediately" style="margin-right: 8px;">
                    Cancel immediately (access will be revoked right away)
                </label>
                <small class="form-help">If unchecked, your subscription will remain active until the end of the current period.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCancelModal()">Keep Subscription</button>
            <button type="button" class="btn btn-danger" onclick="confirmCancelSubscription()">
                <i class="fas fa-times"></i> Cancel Subscription
            </button>
        </div>
    </div>
</div>

<!-- Delete Account Confirmation Modal -->
<div class="modal" id="deleteAccountModal">
    <div class="modal-content">
        <div class="modal-header danger-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Delete Account</h3>
            <button class="modal-close" onclick="closeDeleteAccountModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="danger-message">
                <div class="danger-icon">
                    <i class="fas fa-skull-crossbones"></i>
                </div>
                <h4>This action is PERMANENT and CANNOT be undone!</h4>
                <p>Deleting your account will permanently remove:</p>
                <ul>
                    <li><strong>Your entire account</strong> - username, email, password</li>
                    <li><strong>All budget data</strong> - periods, allocations, categories</li>
                    <li><strong>All transactions</strong> - income, expenses, transfers</li>
                    <li><strong>All settings</strong> - currency, preferences, configurations</li>
                    <li><strong>All historical data</strong> - reports, analytics, insights</li>
                </ul>
                <div class="final-warning">
                    <p><strong>⚠️ FINAL WARNING:</strong> Once you delete your account, there is no way to recover any of your data. This action is irreversible.</p>
                </div>
            </div>
            <div class="form-group">
                <label for="confirmDelete">Type "DELETE MY ACCOUNT" to confirm:</label>
                <input type="text" id="confirmDelete" placeholder="Type DELETE MY ACCOUNT here">
                <small class="form-help">This is case-sensitive and must match exactly</small>
            </div>
            <div class="form-group">
                <label for="deletePassword">Enter your current password:</label>
                <input type="password" id="deletePassword" placeholder="Enter your current password">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteAccountModal()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()" id="confirmDeleteBtn" disabled>
                <i class="fas fa-trash-alt"></i> Permanently Delete Account
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Modal functions
function openPasswordModal() {
    document.getElementById('passwordModal').style.display = 'block';
    document.body.classList.add('modal-open');
}

function closePasswordModal() {
    document.getElementById('passwordModal').style.display = 'none';
    document.getElementById('settingsPasswordForm').reset();
    document.body.classList.remove('modal-open');
    
    // Reset password requirement icons to X marks when closing modal
    const requirements = ['req-length', 'req-uppercase', 'req-lowercase', 'req-number', 'req-special'];
    requirements.forEach(reqId => {
        const reqElement = document.getElementById(reqId);
        if (reqElement) {
            const icon = reqElement.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-times-circle';
                icon.style.color = '#dc3545';
            }
        }
    });
}

function loadUserSettings() {
    return fetch('/api/user/settings', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        return data;
    })
    .catch(error => {
        console.error('Error loading user settings:', error);
        return {};
    });
}

function openDisplayNameModal() {
    // Load current display name
    loadUserSettings().then(settings => {
        document.getElementById('displayName').value = settings.display_name || '';
        document.getElementById('displayNameModal').style.display = 'block';
        document.body.classList.add('modal-open');
    });
}

function closeDisplayNameModal() {
    document.getElementById('displayNameModal').style.display = 'none';
    document.getElementById('displayNameForm').reset();
    document.body.classList.remove('modal-open');
}

function openCurrencyModal() {
    document.getElementById('currencyModal').style.display = 'block';
    document.body.classList.add('modal-open');
}

function closeCurrencyModal() {
    document.getElementById('currencyModal').style.display = 'none';
    document.getElementById('settingsCurrencyForm').reset();
    document.body.classList.remove('modal-open');
}

// Update functions
function updatePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showNotification('Please fill in all fields', 'error');
        return;
    }
    
    // Detailed password validation
    const passwordValidation = validatePasswordDetailed(newPassword);
    if (!passwordValidation.valid) {
        showNotification(passwordValidation.message, 'error');
        document.getElementById('newPassword').focus();
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    // Make API call to update password
    fetch('/api/user/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({
            old_password: currentPassword,
            new_password: newPassword
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.message || 'Failed to update password');
            });
        }
        return response.json();
    })
    .then(data => {
        showNotification(data.message || 'Password updated successfully!', 'success');
        closePasswordModal();
        // Clear form
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
    })
    .catch(error => {
        console.error('Error updating password:', error);
        showNotification('An error occurred while updating password', 'error');
    });
}

function updateDisplayName() {
    let displayName = document.getElementById('displayName').value.trim();
    
    // If empty, set to null so it can fall back to first name
    if (displayName === '') {
        displayName = null;
    }
    
    // Make API call to update display name
    fetch('/api/user/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
            display_name: displayName
        })
    })
    .then(response => {
        return response.json().then(data => ({
            ok: response.ok,
            data: data
        }));
    })
    .then(result => {
        if (result.ok) {
            showNotification('Display name updated successfully!', 'success');
            closeDisplayNameModal();
            // Refresh dashboard to show new display name
            if (window.location.pathname === '/dashboard') {
                loadUserInfo();
            }
        } else {
            showNotification(result.data.message || 'Failed to update display name', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating display name:', error);
        showNotification('An error occurred while updating display name', 'error');
    });
}

// Password strength validation for settings
function updateSettingsPasswordStrength() {
    const password = document.getElementById('newPassword').value;
    const strengthBar = document.getElementById('settingsStrengthBar');
    const strengthText = document.getElementById('settingsStrengthText');
    
    if (password.length === 0) {
        strengthBar.className = 'strength-fill';
        strengthText.textContent = 'Enter a password';
        strengthText.style.color = '#6c757d';
        return;
    }
    
    const { score } = checkPasswordStrength(password);
    
    // Update strength bar
    strengthBar.className = 'strength-fill';
    strengthBar.classList.add(getPasswordStrengthClass(score));
    
    // Update strength text
    strengthText.textContent = getPasswordStrengthText(score);
    
    // Update text color
    if (score <= 1) {
        strengthText.style.color = '#dc3545';
    } else if (score <= 2) {
        strengthText.style.color = '#ffc107';
    } else if (score <= 3) {
        strengthText.style.color = '#17a2b8';
    } else {
        strengthText.style.color = '#28a745';
    }
    
    // Update password requirement checkmarks
    updateSettingsPasswordRequirements(password);
    
    // Check password match
    checkSettingsPasswordMatch();
}

function validatePasswordDetailed(password) {
    if (!password) {
        return { valid: false, message: 'Password is required' };
    }
    if (password.length < 12) {
        return { valid: false, message: 'Password must be at least 12 characters long' };
    }
    if (!/[A-Z]/.test(password)) {
        return { valid: false, message: 'Password must contain at least one uppercase letter' };
    }
    if (!/[a-z]/.test(password)) {
        return { valid: false, message: 'Password must contain at least one lowercase letter' };
    }
    if (!/\d/.test(password)) {
        return { valid: false, message: 'Password must contain at least one number' };
    }
    if (!/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) {
        return { valid: false, message: 'Password must contain at least one special character (!@#$%^&*()_+-=[]{}|;:,.<>?)' };
    }
    return { valid: true, message: '' };
}

function updateSettingsPasswordRequirements(password) {
    // Check each requirement and update the icon
    const checks = {
        'req-length': password.length >= 12,
        'req-uppercase': /[A-Z]/.test(password),
        'req-lowercase': /[a-z]/.test(password),
        'req-number': /[0-9]/.test(password),
        'req-special': /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)
    };
    
    // Update each requirement icon
    Object.keys(checks).forEach(reqId => {
        const reqElement = document.getElementById(reqId);
        if (reqElement) {
            const icon = reqElement.querySelector('i');
            if (icon && checks[reqId]) {
                // Change to checkmark
                icon.className = 'fas fa-check-circle';
                icon.style.color = '#28a745';
            } else if (icon && !checks[reqId]) {
                // Change to X mark
                icon.className = 'fas fa-times-circle';
                icon.style.color = '#dc3545';
            }
        }
    });
}

function checkSettingsPasswordMatch() {
    const password = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const matchDiv = document.getElementById('settingsPasswordMatch');
    
    if (confirmPassword.length === 0) {
        matchDiv.style.display = 'none';
        return;
    }
    
    if (password === confirmPassword) {
        matchDiv.style.display = 'flex';
    } else {
        matchDiv.style.display = 'none';
    }
}

// Get JWT token from localStorage

// Add event listeners when the page loads
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    
    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', updateSettingsPasswordStrength);
    }
    
    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', checkSettingsPasswordMatch);
    }
});

function updateCurrency() {
    const currency = document.getElementById('currencySelect').value;
    
    if (!currency) {
        showNotification('Please select a currency', 'error');
        return;
    }
    
    const data = {
        currency: currency
    };
    
    fetch('/api/user/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        showNotification('Currency updated successfully!', 'success');
        closeCurrencyModal();
        // Update global currency and dispatch event instead of reloading
        userCurrency = currency;
        // Dispatch currency loaded event to update all pages
        window.dispatchEvent(new CustomEvent('currencyLoaded', {
            detail: { currency: currency }
        }));
    })
    .catch(error => {
        console.error('Error updating currency:', error);
        showNotification('Error updating currency. Please try again.', 'error');
    });
}

// Export data functionality
function exportData() {
    showNotification('Preparing Excel export...', 'info');
    
    fetch('/api/user/export-data', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Export failed');
        }
        return response.blob();
    })
    .then(blob => {
        // Create and download Excel file
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `steward-export-${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showNotification('Excel file exported successfully!', 'success');
    })
    .catch(error => {
        console.error('Error exporting data:', error);
        showNotification('Error exporting data. Please try again.', 'error');
    });
}

// Reset data functionality
function resetData() {
    document.getElementById('resetDataModal').style.display = 'block';
    document.body.classList.add('modal-open');
}

function closeResetModal() {
    document.getElementById('resetDataModal').style.display = 'none';
    document.getElementById('confirmReset').value = '';
    document.getElementById('confirmResetBtn').disabled = true;
    document.body.classList.remove('modal-open');
}

// Enable reset button only when "RESET" is typed
document.addEventListener('DOMContentLoaded', function() {
    const confirmInput = document.getElementById('confirmReset');
    const confirmBtn = document.getElementById('confirmResetBtn');
    
    if (confirmInput && confirmBtn) {
        confirmInput.addEventListener('input', function() {
            confirmBtn.disabled = this.value !== 'RESET';
        });
    }
});

function confirmResetData() {
    const confirmInput = document.getElementById('confirmReset');
    if (confirmInput.value !== 'RESET') {
        showNotification('Please type "RESET" to confirm', 'error');
        return;
    }
    
    if (confirm('Are you absolutely sure you want to reset all data? This cannot be undone!')) {
        // Show loading state
        const resetBtn = document.getElementById('confirmResetBtn');
        const originalText = resetBtn.innerHTML;
        resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
        resetBtn.disabled = true;
        
        // Call API to reset data
        fetch('/api/user/reset-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            }
        })
        .then(response => {
            console.log('Reset response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Reset data response:', data);
            if (data.message) {
                showNotification(data.message, 'success');
                closeResetModal();
                // Redirect to dashboard after reset
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            } else {
                showNotification('Data reset successfully!', 'success');
                closeResetModal();
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error resetting data:', error);
            showNotification('Error resetting data. Please try again.', 'error');
            // Reset button state
            resetBtn.innerHTML = originalText;
            resetBtn.disabled = false;
            // Don't close modal on error so user can try again
        });
    }
}

// Delete Account Functions
function openDeleteAccountModal() {
    document.getElementById('deleteAccountModal').style.display = 'block';
    document.body.classList.add('modal-open');
    // Clear form
    document.getElementById('confirmDelete').value = '';
    document.getElementById('deletePassword').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
}

function closeDeleteAccountModal() {
    document.getElementById('deleteAccountModal').style.display = 'none';
    document.body.classList.remove('modal-open');
    // Clear form
    document.getElementById('confirmDelete').value = '';
    document.getElementById('deletePassword').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
}

// Enable/disable delete button based on confirmation text
document.addEventListener('DOMContentLoaded', function() {
    const confirmInput = document.getElementById('confirmDelete');
    const deleteBtn = document.getElementById('confirmDeleteBtn');
    
    if (confirmInput && deleteBtn) {
        confirmInput.addEventListener('input', function() {
            const passwordInput = document.getElementById('deletePassword');
            const isConfirmed = this.value === 'DELETE MY ACCOUNT';
            const hasPassword = passwordInput.value.length > 0;
            
            deleteBtn.disabled = !(isConfirmed && hasPassword);
        });
        
        const passwordInput = document.getElementById('deletePassword');
        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                const isConfirmed = confirmInput.value === 'DELETE MY ACCOUNT';
                const hasPassword = this.value.length > 0;
                
                deleteBtn.disabled = !(isConfirmed && hasPassword);
            });
        }
    }
});

function confirmDeleteAccount() {
    const confirmInput = document.getElementById('confirmDelete');
    const passwordInput = document.getElementById('deletePassword');
    
    if (confirmInput.value !== 'DELETE MY ACCOUNT') {
        showNotification('Please type "DELETE MY ACCOUNT" exactly to confirm', 'error');
        return;
    }
    
    if (!passwordInput.value) {
        showNotification('Please enter your current password', 'error');
        return;
    }
    
    if (confirm('⚠️ FINAL CONFIRMATION ⚠️\n\nAre you absolutely certain you want to permanently delete your account?\n\nThis action CANNOT be undone and will permanently remove ALL your data.\n\nType "YES" in the next prompt to proceed.')) {
        const finalConfirm = prompt('Type "YES" to permanently delete your account:');
        if (finalConfirm === 'YES') {
            // Show loading state
            const deleteBtn = document.getElementById('confirmDeleteBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting Account...';
            deleteBtn.disabled = true;
            
            // Call API to delete account
            fetch('/api/user/delete-account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getToken()
                },
                body: JSON.stringify({
                    password: passwordInput.value
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                showNotification('Account deleted successfully. You will be redirected to the home page.', 'success');
                closeDeleteAccountModal();
                // Clear token and redirect
                localStorage.removeItem('token');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            })
            .catch(error => {
                console.error('Error deleting account:', error);
                showNotification('Error deleting account. Please check your password and try again.', 'error');
                // Reset button state
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            });
        }
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = ['resetDataModal', 'passwordModal', 'currencyModal', 'deleteAccountModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
            switch(modalId) {
                case 'resetDataModal':
                    closeResetModal();
                    break;
                case 'passwordModal':
                    closePasswordModal();
                    break;
                case 'currencyModal':
                    closeCurrencyModal();
                    break;
                case 'deleteAccountModal':
                    closeDeleteAccountModal();
                    break;
            }
        }
    });
}

// Theme Management
function setTheme(theme) {
    // Update the theme in localStorage
    localStorage.setItem('theme', theme);
    
    // Apply the theme to the document
    document.documentElement.setAttribute('data-theme', theme);
    
    // Update theme button states
    document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-theme') === theme) {
            btn.classList.add('active');
        }
    });
    
    // Save theme preference to server
    saveThemePreference(theme);
}

function loadTheme() {
    // Get theme from localStorage or default to 'dark'
    const savedTheme = localStorage.getItem('theme') || 'dark';
    setTheme(savedTheme);
}

function saveThemePreference(theme) {
    fetch('/api/user/theme', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({ theme: theme })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success || data.message) {
            console.log('Theme preference saved');
        } else {
            console.error('Failed to save theme preference');
        }
    })
    .catch(error => {
        console.error('Error saving theme preference:', error);
    });
}

// Load theme on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTheme();
    loadSubscriptionStatus();
});

// Subscription Management Functions
function loadSubscriptionStatus() {
    fetch('/api/subscriptions/status', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        updateSubscriptionUI(data);
    })
    .catch(error => {
        console.error('Error loading subscription status:', error);
        document.getElementById('subscriptionStatusBadge').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error loading status';
    });
}

function updateSubscriptionUI(status) {
    const badge = document.getElementById('subscriptionStatusBadge');
    const planEl = document.getElementById('subscriptionPlan');
    const trialEl = document.getElementById('subscriptionTrial');
    const nextBillingEl = document.getElementById('subscriptionNextBilling');
    
    const statusText = status.status || 'unknown';
    const planText = status.plan ? status.plan.charAt(0).toUpperCase() + status.plan.slice(1) : 'No plan';
    
    // Update badge
    let badgeClass = 'status-badge ';
    let badgeIcon = '';
    if (statusText === 'active') {
        badgeClass += 'status-active';
        badgeIcon = '<i class="fas fa-check-circle"></i> ';
    } else if (statusText === 'trial') {
        badgeClass += 'status-trial';
        badgeIcon = '<i class="fas fa-clock"></i> ';
    } else if (statusText === 'cancelled') {
        badgeClass += 'status-cancelled';
        badgeIcon = '<i class="fas fa-times-circle"></i> ';
    } else if (statusText === 'inactive') {
        badgeClass += 'status-inactive';
        badgeIcon = '<i class="fas fa-pause-circle"></i> ';
    }
    
    badge.className = badgeClass;
    badge.innerHTML = badgeIcon + statusText.toUpperCase();
    
    // Update details
    planEl.textContent = `Plan: ${planText}`;
    
    if (status.trial_end) {
        const trialEnd = new Date(status.trial_end);
        const now = new Date();
        if (trialEnd > now) {
            const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
            trialEl.textContent = `Trial: ${daysLeft} days remaining (ends ${trialEnd.toLocaleDateString()})`;
        } else {
            trialEl.textContent = `Trial: Ended on ${trialEnd.toLocaleDateString()}`;
        }
    } else {
        trialEl.textContent = 'Trial: Not started';
    }
    
    // Update action buttons
    const upgradeBtn = document.getElementById('upgradeBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    
    upgradeBtn.style.display = (statusText === 'trial' || statusText === 'cancelled') ? 'inline-block' : 'none';
    cancelBtn.style.display = (statusText === 'active') ? 'inline-block' : 'none';
    pauseBtn.style.display = (statusText === 'active') ? 'inline-block' : 'none';
    resumeBtn.style.display = (statusText === 'inactive') ? 'inline-block' : 'none';
}

function openPlansModal() {
    fetch('/api/subscriptions/plans', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(plans => {
        const plansList = document.getElementById('plansList');
        plansList.innerHTML = plans.map(plan => {
            const price = (plan.price_cents / 100).toFixed(2);
            return `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                    <h3>${plan.name}</h3>
                    <p style="font-size: 24px; font-weight: bold; color: #28a745;">R${price} / ${plan.interval}</p>
                    <p style="color: #666;">Code: ${plan.code}</p>
                    <button class="btn btn-primary" onclick="startSubscription('${plan.code}')">Start ${plan.name}</button>
                </div>
            `;
        }).join('');
        document.getElementById('plansModal').style.display = 'block';
        document.body.classList.add('modal-open');
    })
    .catch(error => {
        console.error('Error loading plans:', error);
        showNotification('Error loading plans', 'error');
    });
}

function closePlansModal() {
    document.getElementById('plansModal').style.display = 'none';
    document.body.classList.remove('modal-open');
}

function openPaymentsModal() {
    fetch('/api/subscriptions/payments', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(payments => {
        const paymentsList = document.getElementById('paymentsList');
        if (payments.length === 0) {
            paymentsList.innerHTML = '<p>No payment history found.</p>';
        } else {
            paymentsList.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #ddd;">
                            <th style="padding: 10px; text-align: left;">Date</th>
                            <th style="padding: 10px; text-align: left;">Amount</th>
                            <th style="padding: 10px; text-align: left;">Status</th>
                            <th style="padding: 10px; text-align: left;">Reference</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${payments.map(payment => {
                            const date = new Date(payment.created_at);
                            const amount = (payment.amount_cents / 100).toFixed(2);
                            return `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px;">${date.toLocaleDateString()}</td>
                                    <td style="padding: 10px;">${payment.currency} ${amount}</td>
                                    <td style="padding: 10px;"><span style="padding: 4px 8px; border-radius: 4px; background: ${payment.status === 'paid' ? '#d4edda' : payment.status === 'failed' ? '#f8d7da' : '#fff3cd'}; color: ${payment.status === 'paid' ? '#155724' : payment.status === 'failed' ? '#721c24' : '#856404'};">${payment.status}</span></td>
                                    <td style="padding: 10px; font-size: 0.9em; color: #666;">${payment.gateway_reference || 'N/A'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        document.getElementById('paymentsModal').style.display = 'block';
        document.body.classList.add('modal-open');
    })
    .catch(error => {
        console.error('Error loading payments:', error);
        showNotification('Error loading payment history', 'error');
    });
}

function closePaymentsModal() {
    document.getElementById('paymentsModal').style.display = 'none';
    document.body.classList.remove('modal-open');
}

function startSubscription(planCode) {
    fetch('/api/subscriptions/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({ plan: planCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.payfast) {
            // Redirect to PayFast
            showNotification('Redirecting to PayFast...', 'info');
            // Create form and submit to PayFast
            const form = document.createElement('form');
            form.method = 'POST';
            // Use sandbox for testing, production URL otherwise
            const isTestMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            form.action = isTestMode 
                ? 'https://sandbox.payfast.co.za/eng/process' 
                : 'https://www.payfast.co.za/eng/process';
            
            Object.keys(data.payfast).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = data.payfast[key];
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
        } else {
            showNotification('Trial started successfully!', 'success');
            closePlansModal();
            loadSubscriptionStatus();
        }
    })
    .catch(error => {
        console.error('Error starting subscription:', error);
        showNotification('Error starting subscription', 'error');
    });
}

function openCancelModal() {
    document.getElementById('cancelSubscriptionModal').style.display = 'block';
    document.body.classList.add('modal-open');
}

function closeCancelModal() {
    document.getElementById('cancelSubscriptionModal').style.display = 'none';
    document.getElementById('cancelImmediately').checked = false;
    document.body.classList.remove('modal-open');
}

function confirmCancelSubscription() {
    const cancelImmediately = document.getElementById('cancelImmediately').checked;
    
    fetch('/api/subscriptions/cancel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({ immediately: cancelImmediately })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message || 'Subscription cancelled successfully', 'success');
        closeCancelModal();
        loadSubscriptionStatus();
    })
    .catch(error => {
        console.error('Error cancelling subscription:', error);
        showNotification('Error cancelling subscription', 'error');
    });
}

function pauseSubscription() {
    if (!confirm('Are you sure you want to pause your subscription?')) {
        return;
    }
    
    fetch('/api/subscriptions/pause', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message || 'Subscription paused successfully', 'success');
        loadSubscriptionStatus();
    })
    .catch(error => {
        console.error('Error pausing subscription:', error);
        showNotification('Error pausing subscription', 'error');
    });
}

function resumeSubscription() {
    fetch('/api/subscriptions/resume', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message || 'Subscription resumed successfully', 'success');
        loadSubscriptionStatus();
    })
    .catch(error => {
        console.error('Error resuming subscription:', error);
        showNotification('Error resuming subscription', 'error');
    });
}

function openUpgradeModal() {
    openPlansModal();
}
</script>
{% endblock %}
