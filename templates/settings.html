{% extends "base.html" %}

{% block title %}Settings - STEWARD{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Settings</h1>
        <p class="page-subtitle">Manage your account preferences and currency settings.</p>
    </div>

    <!-- Settings Header with Quick Actions -->
    <div class="settings-header">
        <div class="header-left">
            <h2>Account Settings</h2>
            <p>Manage your account information and preferences</p>
        </div>
        <div class="header-right">
            <button class="btn btn-secondary" onclick="openCurrencyModal()">
                <i class="fas fa-dollar-sign"></i>
                Change Currency
            </button>
            <button class="btn btn-secondary" onclick="openPasswordModal()">
                <i class="fas fa-key"></i>
                Change Password
            </button>
        </div>
    </div>

    <!-- Main Settings Form -->
    <div class="card settings-card">
        <div class="card-body">
            <form id="mainSettingsForm" class="settings-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" readonly class="readonly-input">
                    <small class="form-help">Username cannot be changed</small>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Save Email
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- App Information (Minimal) -->
    <div class="app-info-card">
        <div class="app-info-content">
            <div class="app-version">
                <span class="version-label">Wealth Wise v1.0.0</span>
            </div>
            <div class="app-inspiration">
                <p>"The plans of the diligent lead to profit as surely as haste leads to poverty."</p>
                <span class="verse-reference">- Proverbs 21:5</span>
            </div>
        </div>
    </div>
</div>

<!-- Currency Change Modal -->
<div id="currencyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Change Currency</h3>
            <button class="modal-close" onclick="closeCurrencyModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="currencyForm" class="modal-form">
                <div class="form-group">
                    <label for="modalCurrency">Default Currency</label>
                    <select id="modalCurrency" name="currency" required>
                        <option value="USD">USD ($) - US Dollar</option>
                        <option value="EUR">EUR (€) - Euro</option>
                        <option value="GBP">GBP (£) - British Pound</option>
                        <option value="ZAR">ZAR (R) - South African Rand</option>
                        <option value="CAD">CAD (C$) - Canadian Dollar</option>
                        <option value="AUD">AUD (A$) - Australian Dollar</option>
                        <option value="BWP">BWP (P) - Botswana Pula</option>
                        <option value="ZMW">ZMW (K) - Zambian Kwacha</option>
                        <option value="NGN">NGN (₦) - Nigerian Naira</option>
                        <option value="KES">KES (KSh) - Kenyan Shilling</option>
                        <option value="GHS">GHS (₵) - Ghanaian Cedi</option>
                        <option value="UGX">UGX (USh) - Ugandan Shilling</option>
                        <option value="TZS">TZS (TSh) - Tanzanian Shilling</option>
                        <option value="ETB">ETB (Br) - Ethiopian Birr</option>
                        <option value="RWF">RWF (RF) - Rwandan Franc</option>
                        <option value="MWK">MWK (MK) - Malawian Kwacha</option>
                        <option value="BRL">BRL (R$) - Brazilian Real</option>
                        <option value="MXN">MXN ($) - Mexican Peso</option>
                        <option value="PHP">PHP (₱) - Philippine Peso</option>
                        <option value="INR">INR (₹) - Indian Rupee</option>
                        <option value="JPY">JPY (¥) - Japanese Yen</option>
                    </select>
                    <small class="form-help">This will be used for displaying all monetary values</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCurrencyModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveCurrency()">
                <i class="fas fa-save"></i>
                Save Currency
            </button>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div id="passwordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Change Password</h3>
            <button class="modal-close" onclick="closePasswordModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="passwordForm" class="modal-form">
                <div class="form-group">
                    <label for="modalCurrentPassword">Current Password</label>
                    <input type="password" id="modalCurrentPassword" name="current_password" required>
                </div>
                <div class="form-group">
                    <label for="modalNewPassword">New Password</label>
                    <input type="password" id="modalNewPassword" name="new_password" required minlength="6">
                    <small class="form-help">Password must be at least 6 characters long</small>
                </div>
                <div class="form-group">
                    <label for="modalConfirmPassword">Confirm New Password</label>
                    <input type="password" id="modalConfirmPassword" name="confirm_password" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="savePassword()">
                <i class="fas fa-key"></i>
                Change Password
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show notification function
function showNotification(message, type = 'success') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    loadUserSettings();
    setupFormListeners();
});

// Modal functions
function openCurrencyModal() {
    const modal = document.getElementById('currencyModal');
    const currentCurrency = document.getElementById('currency').value;
    document.getElementById('modalCurrency').value = currentCurrency;
    modal.style.display = 'block';
}

function closeCurrencyModal() {
    document.getElementById('currencyModal').style.display = 'none';
    document.getElementById('currencyForm').reset();
}

function openPasswordModal() {
    const modal = document.getElementById('passwordModal');
    modal.style.display = 'block';
}

function closePasswordModal() {
    document.getElementById('passwordModal').style.display = 'none';
    document.getElementById('passwordForm').reset();
}

// Close modals when clicking outside
window.onclick = function(event) {
    const currencyModal = document.getElementById('currencyModal');
    const passwordModal = document.getElementById('passwordModal');
    
    if (event.target === currencyModal) {
        closeCurrencyModal();
    }
    if (event.target === passwordModal) {
        closePasswordModal();
    }
}

function loadUserSettings() {
    fetch('/api/user/settings', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('username').value = data.username;
        document.getElementById('email').value = data.email;
        // Store currency for modal use
        document.getElementById('currency').value = data.currency;
    })
    .catch(error => console.error('Error loading user settings:', error));
}

function setupFormListeners() {
    document.getElementById('mainSettingsForm').addEventListener('submit', handleMainSettingsUpdate);
}

function handleMainSettingsUpdate(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        email: formData.get('email')
    };
    
    fetch('/api/user/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showNotification(data.message, 'success');
        } else {
            showNotification('Email updated successfully!', 'success');
        }
    })
    .catch(error => {
        console.error('Error updating email:', error);
        showNotification('Error updating email. Please try again.', 'error');
    });
}

function saveCurrency() {
    const currency = document.getElementById('modalCurrency').value;
    
    const data = {
        currency: currency
    };
    
    fetch('/api/user/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        showNotification('Currency updated successfully!', 'success');
        closeCurrencyModal();
        // Reload the page to update currency formatting
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        console.error('Error updating currency:', error);
        showNotification('Error updating currency. Please try again.', 'error');
    });
}

function savePassword() {
    const currentPassword = document.getElementById('modalCurrentPassword').value;
    const newPassword = document.getElementById('modalNewPassword').value;
    const confirmPassword = document.getElementById('modalConfirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        showNotification('New passwords do not match', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showNotification('Password must be at least 6 characters long', 'error');
        return;
    }
    
    const data = {
        current_password: currentPassword,
        new_password: newPassword
    };
    
    fetch('/api/user/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showNotification(data.message, 'success');
            closePasswordModal();
        } else {
            showNotification('Password changed successfully!', 'success');
            closePasswordModal();
        }
    })
    .catch(error => {
        console.error('Error changing password:', error);
        showNotification('Error changing password. Please try again.', 'error');
    });
}

</script>
{% endblock %}
