{% extends "base.html" %}

{% block title %}Dashboard - STEWARD{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="header-content">
            <div>
                <h1>Dashboard</h1>
                <p class="page-subtitle">Welcome back! Here's your financial overview.</p>
            </div>
            <div class="budget-period-indicator">
                <div class="current-budget">
                    <span id="current-budget-name" class="budget-name">Loading...</span>
                    <a href="/budgets" class="budget-manage-link">
                        <i class="fas fa-edit"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Balance Alert -->
    <div id="budget-balance-alert" class="budget-alert" style="display: none;">
        <div class="alert-content">
            <div class="alert-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alert-message">
                <h3>Budget Unbalanced</h3>
                <p id="budget-alert-text">Your total allocated budget exceeds your total income.</p>
            </div>
            <div class="alert-actions">
                <a href="/breakdown" class="btn btn-primary">Fix Budget</a>
                <button onclick="dismissBudgetAlert()" class="btn btn-secondary">Dismiss</button>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Financial Overview Cards -->
        <div class="overview-cards">
            <div class="overview-card income-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="card-title">
                        <h3>Total Income</h3>
                        <p>This period</p>
                    </div>
                </div>
                <div class="card-value">
                    <span id="totalIncome" class="value">$0.00</span>
                </div>
            </div>
            
            <div class="overview-card balance-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="card-title">
                        <h3>Balance</h3>
                        <p>Income - Spent</p>
                    </div>
                </div>
                <div class="card-value">
                    <span id="balance" class="value">$0.00</span>
                </div>
            </div>
        </div>

        <!-- Right Content Area -->
        <div class="right-content">
            <!-- Progress Visualization -->
            <div class="progress-section">
                <div class="progress-card">
                    <div class="progress-header">
                        <h3>Budget Progress</h3>
                        <div class="progress-stats">
                            <span id="progressPercentage">0%</span>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div id="progressBar" class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="progress-details">
                        <div class="progress-item">
                            <span class="label">Allocated:</span>
                            <span id="allocatedAmount" class="amount">$0.00</span>
                        </div>
                        <div class="progress-item">
                            <span class="label">Spent:</span>
                            <span id="spentAmount" class="amount">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="actions-section">
                <div class="actions-card">
                    <div class="actions-header">
                        <h3>Quick Actions</h3>
                        <p>Manage your budget efficiently</p>
                    </div>
                    <div class="actions-grid">
                        <a href="/breakdown" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="action-content">
                                <h4>Budget Breakdown</h4>
                                <p>View and manage categories</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        
                        <a href="/income" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="action-content">
                                <h4>Manage Income</h4>
                                <p>Add and track income sources</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        
                        <a href="#" class="action-item" onclick="openAddExpenseModal(); return false;">
                            <div class="action-icon">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <div class="action-content">
                                <h4>Add Expense</h4>
                                <p>Record new transactions</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        
                        <a href="/transactions" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-list-alt"></i>
                            </div>
                            <div class="action-content">
                                <h4>View Transactions</h4>
                                <p>Review spending history</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load dashboard data immediately, currency will be loaded globally
    loadDashboardData();
    
    // Also listen for currency loaded event
    window.addEventListener('currencyLoaded', function(event) {
        userCurrency = event.detail.currency;
        loadDashboardData();
    });
    
    // Listen for budget period changes
    window.addEventListener('budgetPeriodChanged', function(event) {
        loadDashboardData();
    });
});

function loadDashboardData() {
    // First load user settings to get currency, then load other data
    loadUserSettings().then(() => {
        // Load budget summary
        fetch('/api/budget', {
            headers: {
                'Authorization': 'Bearer ' + getToken()
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            const totalIncome = data.total_income + (data.balance_brought_forward || 0);
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome, userCurrency);
            
            // Update budget period indicator
            document.getElementById('current-budget-name').textContent = data.period_name || 'Unknown';
        })
        .catch(error => {
            console.error('Error loading budget:', error);
            document.getElementById('current-budget-name').textContent = 'Error loading budget';
            showNotification('Error loading budget: ' + error.message, 'error');
        });

        // Load categories for overview
        loadCategoriesOverview();
        
        // Check budget balance
        checkBudgetBalance();
    });
}

function loadUserSettings() {
    return fetch('/api/user/settings', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        userCurrency = data.currency || 'USD';
        return data;
    })
    .catch(error => {
        console.error('Error loading user settings:', error);
        userCurrency = 'USD';
        return { currency: 'USD' };
    });
}

function loadCategoriesOverview() {
    fetch('/api/categories', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(categories => {
        let totalAllocated = 0;
        let totalSpent = 0;

        categories.forEach(category => {
            const categoryAllocated = category.subcategories.reduce((sum, sub) => sum + (sub.allocated || 0), 0);
            const categorySpent = category.subcategories.reduce((sum, sub) => sum + (sub.spent || 0), 0);
            
            totalAllocated += categoryAllocated;
            totalSpent += categorySpent;
        });

        // Calculate balance (Income - Spent)
        const totalIncome = parseFloat(document.getElementById('totalIncome').textContent.replace(/[^0-9.-]/g, '')) || 0;
        const balance = totalIncome - totalSpent;
        document.getElementById('balance').textContent = formatCurrency(balance, userCurrency);
        
        // Update progress visualization
        updateProgressVisualization(totalAllocated, totalSpent);
    })
    .catch(error => console.error('Error loading categories:', error));
}

function updateProgressVisualization(allocated, spent) {
    // Update progress details
    document.getElementById('allocatedAmount').textContent = formatCurrency(allocated, userCurrency);
    document.getElementById('spentAmount').textContent = formatCurrency(spent, userCurrency);
    
    // Calculate progress percentage
    const percentage = allocated > 0 ? Math.min((spent / allocated) * 100, 100) : 0;
    document.getElementById('progressPercentage').textContent = Math.round(percentage) + '%';
    
    // Update progress bar
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = percentage + '%';
    
    // Add color coding based on progress
    progressBar.className = 'progress-fill';
    if (percentage > 90) {
        progressBar.classList.add('over-budget');
    } else if (percentage > 75) {
        progressBar.classList.add('warning');
    } else {
        progressBar.classList.add('on-track');
    }
}

function formatCurrency(amount, currency = userCurrency || 'USD') {
    const symbol = getCurrencySymbol(currency);
    const formatter = new Intl.NumberFormat('en-US', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    return symbol + formatter.format(amount || 0);
}

// Modal functions
function openAddExpenseModal() {
    document.getElementById('modalTransactionDate').value = new Date().toISOString().split('T')[0];
    loadModalCategories();
    document.getElementById('addExpenseModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function loadModalCategories() {
    fetch('/api/categories', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(categories => {
        const categorySelect = document.getElementById('modalCategory');
        categorySelect.innerHTML = '<option value="">Select a category</option>';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            option.dataset.subcategories = JSON.stringify(category.subcategories);
            categorySelect.appendChild(option);
        });
    })
    .catch(error => console.error('Error loading categories:', error));
}

function loadModalSubcategories() {
    const categorySelect = document.getElementById('modalCategory');
    const subcategorySelect = document.getElementById('modalSubcategory');
    
    subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
    
    const selectedCategory = categorySelect.options[categorySelect.selectedIndex];
    if (selectedCategory.value && selectedCategory.dataset.subcategories) {
        const subcategories = JSON.parse(selectedCategory.dataset.subcategories);
        subcategories.forEach(subcategory => {
            const option = document.createElement('option');
            option.value = subcategory.id;
            option.textContent = subcategory.name;
            subcategorySelect.appendChild(option);
        });
    }
}

// Modal form submission
document.addEventListener('DOMContentLoaded', function() {
    const addExpenseForm = document.getElementById('addExpenseForm');
    if (addExpenseForm) {
        addExpenseForm.addEventListener('submit', handleModalExpenseSubmit);
    }
});

function handleModalExpenseSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        amount: parseFloat(formData.get('amount')),
        transaction_date: formData.get('transaction_date'),
        description: formData.get('description'),
        comment: formData.get('comment'),
        subcategory_id: parseInt(formData.get('subcategory'))
    };
    
    // Validation
    if (!data.amount || data.amount <= 0) {
        showNotification('Please enter a valid amount', 'error');
        return;
    }
    
    if (!data.transaction_date) {
        showNotification('Please select a transaction date', 'error');
        return;
    }
    
    if (!data.subcategory_id) {
        showNotification('Please select a subcategory', 'error');
        return;
    }
    
    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    submitBtn.disabled = true;
    
    // Make API call
    fetch('/api/transactions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        showNotification('Expense added successfully!', 'success');
        closeModal('addExpenseModal');
        resetModalForm();
        loadDashboardData(); // Refresh dashboard data
    })
    .catch(error => {
        console.error('Error adding expense:', error);
        const errorMessage = error.error || error.message || 'Error adding expense. Please try again.';
        showNotification(errorMessage, 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function resetModalForm() {
    document.getElementById('addExpenseForm').reset();
    document.getElementById('modalTransactionDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('modalSubcategory').innerHTML = '<option value="">Select a subcategory</option>';
}

function checkBudgetBalance() {
    fetch('/api/budget/balance-check', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (!data.is_balanced) {
            showBudgetAlert(data);
        } else {
            hideBudgetAlert();
        }
    })
    .catch(error => {
        console.error('Error checking budget balance:', error);
        // Don't show error notification for balance check failures
    });
}

function showBudgetAlert(balanceData) {
    const alert = document.getElementById('budget-balance-alert');
    const alertText = document.getElementById('budget-alert-text');
    
    const deficit = balanceData.deficit || 0;
    const totalIncome = balanceData.total_income || 0;
    const totalAllocated = balanceData.total_allocated || 0;
    
    alertText.textContent = `Your total allocated budget (${formatCurrency(totalAllocated, userCurrency)}) exceeds your total income (${formatCurrency(totalIncome, userCurrency)}) by ${formatCurrency(deficit, userCurrency)}. Please adjust your budget allocations.`;
    
    alert.style.display = 'block';
}

function hideBudgetAlert() {
    const alert = document.getElementById('budget-balance-alert');
    alert.style.display = 'none';
}

function dismissBudgetAlert() {
    hideBudgetAlert();
}
</script>
{% endblock %}
