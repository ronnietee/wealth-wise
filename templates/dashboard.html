{% extends "base.html" %}

{% block title %}Dashboard - STEWARD{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="header-content">
            <div>
                <h1>Dashboard</h1>
                <p class="page-subtitle">Welcome back! Here's your financial overview.</p>
            </div>
            <div class="budget-period-indicator">
                <div class="current-budget">
                    <span class="budget-label">Current Budget:</span>
                    <span id="current-budget-name" class="budget-name">Loading...</span>
                </div>
                <a href="/budgets" class="btn btn-sm btn-outline">Manage Budgets</a>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Financial Overview Cards -->
        <div class="overview-cards">
            <div class="overview-card income-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="card-title">
                        <h3>Total Income</h3>
                        <p>This period</p>
                    </div>
                </div>
                <div class="card-value">
                    <span id="totalIncome" class="value">$0.00</span>
                </div>
            </div>
            
            <div class="overview-card balance-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="card-title">
                        <h3>Balance</h3>
                        <p>Income - Spent</p>
                    </div>
                </div>
                <div class="card-value">
                    <span id="balance" class="value">$0.00</span>
                </div>
            </div>
        </div>

        <!-- Right Content Area -->
        <div class="right-content">
            <!-- Progress Visualization -->
            <div class="progress-section">
                <div class="progress-card">
                    <div class="progress-header">
                        <h3>Budget Progress</h3>
                        <div class="progress-stats">
                            <span id="progressPercentage">0%</span>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div id="progressBar" class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="progress-details">
                        <div class="progress-item">
                            <span class="label">Allocated:</span>
                            <span id="allocatedAmount" class="amount">$0.00</span>
                        </div>
                        <div class="progress-item">
                            <span class="label">Spent:</span>
                            <span id="spentAmount" class="amount">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="actions-section">
                <div class="actions-card">
                    <div class="actions-header">
                        <h3>Quick Actions</h3>
                        <p>Manage your budget efficiently</p>
                    </div>
                    <div class="actions-grid">
                        <a href="/breakdown" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="action-content">
                                <h4>Budget Breakdown</h4>
                                <p>View and manage categories</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        
                        <a href="/income" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="action-content">
                                <h4>Manage Income</h4>
                                <p>Add and track income sources</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        
                        <a href="/transactions" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <div class="action-content">
                                <h4>Add Expense</h4>
                                <p>Record new transactions</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        
                        <a href="/transactions" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-list-alt"></i>
                            </div>
                            <div class="action-content">
                                <h4>View Transactions</h4>
                                <p>Review spending history</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load dashboard data immediately, currency will be loaded globally
    loadDashboardData();
    
    // Also listen for currency loaded event
    window.addEventListener('currencyLoaded', function(event) {
        userCurrency = event.detail.currency;
        loadDashboardData();
    });
    
    // Listen for budget period changes
    window.addEventListener('budgetPeriodChanged', function(event) {
        loadDashboardData();
    });
});

function loadDashboardData() {
    // First load user settings to get currency, then load other data
    loadUserSettings().then(() => {
        // Load budget summary
        fetch('/api/budget', {
            headers: {
                'Authorization': 'Bearer ' + getToken()
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            const totalIncome = data.total_income + (data.balance_brought_forward || 0);
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome, userCurrency);
            
            // Update budget period indicator
            document.getElementById('current-budget-name').textContent = data.period_name || 'Unknown';
        })
        .catch(error => {
            console.error('Error loading budget:', error);
            document.getElementById('current-budget-name').textContent = 'Error loading budget';
            showNotification('Error loading budget: ' + error.message, 'error');
        });

        // Load categories for overview
        loadCategoriesOverview();
    });
}

function loadUserSettings() {
    return fetch('/api/user/settings', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        userCurrency = data.currency || 'USD';
        return data;
    })
    .catch(error => {
        console.error('Error loading user settings:', error);
        userCurrency = 'USD';
        return { currency: 'USD' };
    });
}

function loadCategoriesOverview() {
    fetch('/api/categories', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => response.json())
    .then(categories => {
        let totalAllocated = 0;
        let totalSpent = 0;

        categories.forEach(category => {
            const categoryAllocated = category.subcategories.reduce((sum, sub) => sum + (sub.allocated || 0), 0);
            const categorySpent = category.subcategories.reduce((sum, sub) => sum + (sub.spent || 0), 0);
            
            totalAllocated += categoryAllocated;
            totalSpent += categorySpent;
        });

        // Calculate balance (Income - Spent)
        const totalIncome = parseFloat(document.getElementById('totalIncome').textContent.replace(/[^0-9.-]/g, '')) || 0;
        const balance = totalIncome - totalSpent;
        document.getElementById('balance').textContent = formatCurrency(balance, userCurrency);
        
        // Update progress visualization
        updateProgressVisualization(totalAllocated, totalSpent);
    })
    .catch(error => console.error('Error loading categories:', error));
}

function updateProgressVisualization(allocated, spent) {
    // Update progress details
    document.getElementById('allocatedAmount').textContent = formatCurrency(allocated, userCurrency);
    document.getElementById('spentAmount').textContent = formatCurrency(spent, userCurrency);
    
    // Calculate progress percentage
    const percentage = allocated > 0 ? Math.min((spent / allocated) * 100, 100) : 0;
    document.getElementById('progressPercentage').textContent = Math.round(percentage) + '%';
    
    // Update progress bar
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = percentage + '%';
    
    // Add color coding based on progress
    progressBar.className = 'progress-fill';
    if (percentage > 90) {
        progressBar.classList.add('over-budget');
    } else if (percentage > 75) {
        progressBar.classList.add('warning');
    } else {
        progressBar.classList.add('on-track');
    }
}

function formatCurrency(amount, currency = userCurrency || 'USD') {
    const symbol = getCurrencySymbol(currency);
    const formatter = new Intl.NumberFormat('en-US', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    return symbol + formatter.format(amount || 0);
}
</script>
{% endblock %}
