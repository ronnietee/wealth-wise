{% extends "base.html" %}

{% block title %}Dashboard - STEWARD{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="header-content">
            <div>
                <h1>Dashboard</h1>
                <p class="page-subtitle">Welcome back<span id="user-name"></span>! Here's your financial overview.</p>
            </div>
            <div class="budget-period-indicator">
                <div class="current-budget">
                    <span id="current-budget-name" class="budget-name budget-period-loading">Loading...</span>
                    <a href="/budgets" class="budget-manage-link">
                        <i class="fas fa-edit"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- No Budget Message -->
    <div id="no-budget-message" class="no-budget-card" style="display: none;">
        <div class="no-budget-content">
            <div class="no-budget-icon">
                <i class="fas fa-plus-circle"></i>
            </div>
            <div class="no-budget-message">
                <h3>No Budget Period Found</h3>
                <p>You don't have any budget periods set up yet. Create your first budget to start managing your finances.</p>
            </div>
            <div class="no-budget-actions">
                <a href="/budgets" class="btn btn-primary">Create Budget</a>
            </div>
        </div>
    </div>

    <!-- Budget Balance Alert -->
    <div id="budget-balance-alert" class="budget-alert" style="display: none;">
        <div class="alert-content">
            <div class="alert-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alert-message">
                <h3>Budget Unbalanced</h3>
                <p id="budget-alert-text">Your total allocated budget exceeds your total income.</p>
            </div>
            <div class="alert-actions">
                <a href="/breakdown" class="btn btn-primary">Fix Budget</a>
                <button onclick="dismissBudgetAlert()" class="btn btn-secondary">Dismiss</button>
            </div>
        </div>
    </div>

    <!-- Overspending Alert -->
    <div id="overspending-alert" class="overspending-alert" style="display: none;">
        <div class="alert-content">
            <div class="alert-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="alert-message">
                <h3>Overspending Detected</h3>
                <p id="overspending-alert-text">You have exceeded your allocated budget in some categories.</p>
                <div id="overspending-details" class="overspending-details"></div>
            </div>
            <div class="alert-actions">
                <a href="/breakdown" class="btn btn-primary">View Breakdown</a>
                <button onclick="dismissOverspendingAlert()" class="btn btn-secondary">Dismiss</button>
            </div>
        </div>
    </div>

    <div class="dashboard-content">
        <div class="dashboard-grid">
        <!-- Financial Overview Cards -->
        <div class="overview-cards">
            <div class="overview-card income-card compact card-loading" id="income-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="card-title">
                        <h3>Total Income</h3>
                        <p>This period</p>
                    </div>
                </div>
                <div class="card-value">
                    <span id="totalIncome" class="value">$0.00</span>
                </div>
            </div>
            
            <div class="overview-card balance-card compact card-loading" id="balance-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="card-title">
                        <h3>Balance</h3>
                        <p>Income - Spent</p>
                    </div>
                </div>
                <div class="card-value">
                    <span id="balance" class="value">$0.00</span>
                </div>
            </div>
            
            <div class="overview-card available-card compact card-loading" id="available-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="card-title">
                        <h3>Available to Allocate</h3>
                        <p>Unallocated funds</p>
                    </div>
                </div>
                <div class="card-value">
                    <span id="availableToAllocate" class="value">$0.00</span>
                </div>
            </div>
            
            <div class="overview-card days-card compact card-loading" id="days-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="card-title">
                        <h3>Days Remaining</h3>
                        <p>Budget period</p>
                    </div>
                </div>
                <div class="card-value">
                    <span id="daysRemaining" class="value">0</span>
                </div>
            </div>
        </div>

        <!-- Budget Progress Section -->
        <div class="progress-section">
            <div class="progress-card">
                <div class="progress-header">
                    <h3>Budget Progress</h3>
                </div>
                <div class="score-card progress-loading" id="progress-card">
                    <div class="score-percentage">
                        <span id="progressPercentage">0%</span>
                    </div>
                    <div class="score-details">
                        <span class="score-label">Total Spent</span>
                        <span id="totalSpent" class="score-amount">$0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Allocation Chart Section -->
        <div class="chart-section">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Budget Allocation</h3>
                    <p>Distribution of your budget across categories</p>
                </div>
                <div class="chart-container chart-loading" id="chart-container">
                    <canvas id="budgetChart" width="400" height="400"></canvas>
                </div>
                <div class="chart-legend" id="chartLegend">
                    <!-- Legend will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Right Content Area -->
        <div class="right-content">
            <!-- Quick Actions -->
            <div class="actions-section">
                <div class="actions-card">
                    <div class="actions-header">
                        <h3>Quick Actions</h3>
                        <p>Manage your budget efficiently</p>
                    </div>
                    <div class="actions-grid">
                        <a href="/breakdown" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="action-content">
                                <h4>Budget Breakdown</h4>
                                <p>View and manage categories</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        
                        <a href="/income" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="action-content">
                                <h4>Manage Income</h4>
                                <p>Add and track income sources</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        
                        <a href="#" class="action-item" onclick="openAddExpenseModal(); return false;">
                            <div class="action-icon">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <div class="action-content">
                                <h4>Add Expense</h4>
                                <p>Record new transactions</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        
                        <a href="#" class="action-item" onclick="exportData(); return false;">
                            <div class="action-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="action-content">
                                <h4>Export Data</h4>
                                <p>Download your financial data</p>
                            </div>
                            <div class="action-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize loading states
    initializeLoadingStates();
    
    // Load user information from JWT token
    loadUserInfo();
    
    // Load dashboard data immediately, currency will be loaded globally
    loadDashboardData();
    
    // Also listen for currency loaded event
    window.addEventListener('currencyLoaded', function(event) {
        userCurrency = event.detail.currency;
        loadDashboardData();
    });
    
    // Listen for budget period changes
    window.addEventListener('budgetPeriodChanged', function(event) {
        loadDashboardData();
    });
});

// Dashboard-specific loading state management
function initializeLoadingStates() {
    // Show loading states for all dashboard components
    LoadingManager.showMultiple([
        'current-budget-name',
        'income-card',
        'balance-card',
        'available-card',
        'days-card',
        'progress-card',
        'chart-container'
    ]);
    
    // Set a timeout to hide all loading states after 10 seconds as a fallback
    setTimeout(() => {
        hideAllLoadingStates();
    }, 10000);
}

function hideAllLoadingStates() {
    LoadingManager.hideMultiple([
        'current-budget-name',
        'income-card',
        'balance-card',
        'available-card',
        'days-card',
        'progress-card',
        'chart-container'
    ]);
}

function loadUserInfo() {
    const token = localStorage.getItem('token');
    if (token) {
        try {
            // Decode JWT token to get user info
            const payload = JSON.parse(atob(token.split('.')[1]));
            const userId = payload.user_id;
            
            // Fetch user details
            authenticatedFetch('/api/user/profile')
            .then(response => response.json())
            .then(data => {
                console.log('User profile data:', data);
                let displayName = '';
                if (data.display_name) {
                    displayName = data.display_name;
                    console.log('Using display_name:', displayName);
                } else if (data.preferred_name) {
                    displayName = data.preferred_name;
                    console.log('Using preferred_name:', displayName);
                } else if (data.first_name) {
                    displayName = data.first_name;
                    console.log('Using first_name:', displayName);
                } else if (data.username) {
                    displayName = data.username;
                    console.log('Using username:', displayName);
                }
                
                if (displayName) {
                    document.getElementById('user-name').textContent = ', ' + displayName;
                    console.log('Set user name to:', displayName);
                }
            })
            .catch(error => {
                console.error('Error loading user info:', error);
                // Fallback: try to get first name or username from token payload if available
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    if (payload.first_name) {
                        document.getElementById('user-name').textContent = ', ' + payload.first_name;
                    } else if (payload.username) {
                        document.getElementById('user-name').textContent = ', ' + payload.username;
                    }
                } catch (tokenError) {
                    console.error('Error decoding token in fallback:', tokenError);
                }
            });
        } catch (error) {
            console.error('Error decoding token:', error);
        }
    }
}

function loadDashboardData() {
    // First load user settings to get currency, then load other data
    loadUserSettings().then(() => {
        // Load budget summary
        authenticatedFetch('/api/budget')
        .then(response => {
            if (response.status === 404) {
                // No budget found, show no budget message
                showNoBudgetMessage();
                LoadingManager.hideMultiple(['current-budget-name', 'income-card', 'days-card']);
                return;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // Skip if we already handled 404 above
            
            if (data.error) {
                throw new Error(data.error);
            }
            const totalIncome = data.total_income + (data.balance_brought_forward || 0);
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome, userCurrency);
            
            // Update budget period indicator and hide loading
            document.getElementById('current-budget-name').textContent = data.period_name || 'Unknown';
            LoadingManager.hideMultiple(['current-budget-name', 'income-card']);
            
            // Hide no budget message if it was showing
            hideNoBudgetMessage();
            
            // Load other data now that we have a budget
            loadCategoriesOverview();
            loadBudgetChart();
            calculateDaysRemaining(data);
            checkBudgetBalance();
            checkOverspending();
        })
        .catch(error => {
            console.error('Error loading budget:', error);
            document.getElementById('current-budget-name').textContent = 'Error loading budget';
            LoadingManager.hideMultiple(['current-budget-name', 'income-card']);
            showNotification('Error loading budget: ' + error.message, 'error');
        });

    });
}

function loadUserSettings() {
    return authenticatedFetch('/api/user/settings')
    .then(response => response.json())
    .then(data => {
        userCurrency = data.currency || 'USD';
        return data;
    })
    .catch(error => {
        console.error('Error loading user settings:', error);
        userCurrency = 'USD';
        return { currency: 'USD' };
    });
}

function loadCategoriesOverview() {
    authenticatedFetch('/api/categories')
    .then(response => response.json())
    .then(categories => {
        let totalAllocated = 0;
        let totalSpent = 0;

        categories.forEach(category => {
            const categoryAllocated = category.subcategories.reduce((sum, sub) => sum + (sub.allocated || 0), 0);
            const categorySpent = category.subcategories.reduce((sum, sub) => sum + (sub.spent || 0), 0);
            
            totalAllocated += categoryAllocated;
            totalSpent += categorySpent;
        });

        // Calculate balance (Income - Spent)
        const totalIncome = parseFloat(document.getElementById('totalIncome').textContent.replace(/[^0-9.-]/g, '')) || 0;
        const balance = totalIncome - totalSpent;
        document.getElementById('balance').textContent = formatCurrency(balance, userCurrency);
        
        // Calculate available to allocate (Income - Allocated)
        const availableToAllocate = totalIncome - totalAllocated;
        document.getElementById('availableToAllocate').textContent = formatCurrency(availableToAllocate, userCurrency);
        
        // Hide loading states for balance and available cards
        LoadingManager.hideMultiple(['balance-card', 'available-card']);
        
        // Update progress visualization
        updateProgressVisualization(totalAllocated, totalSpent);
    })
    .catch(error => {
        console.error('Error loading categories:', error);
        // Hide loading states even on error
        LoadingManager.hideMultiple(['balance-card', 'available-card']);
    });
}

function updateProgressVisualization(allocated, spent) {
    // Calculate progress percentage based on Total Income - Spent
    const totalIncome = parseFloat(document.getElementById('totalIncome').textContent.replace(/[^0-9.-]/g, '')) || 0;
    const percentage = totalIncome > 0 ? Math.min((spent / totalIncome) * 100, 100) : 0;
    document.getElementById('progressPercentage').textContent = Math.round(percentage) + '%';
    
    // Update total spent amount
    document.getElementById('totalSpent').textContent = formatCurrency(spent, userCurrency);
    
    // Hide progress loading state
    LoadingManager.hide('progress-card');
    
    // Add color coding based on spending level
    const scorePercentage = document.getElementById('progressPercentage').parentElement;
    scorePercentage.className = 'score-percentage';
    
    if (percentage > 90) {
        scorePercentage.classList.add('high-spending');
    } else if (percentage > 75) {
        scorePercentage.classList.add('moderate-spending');
    } else {
        scorePercentage.classList.add('low-spending');
    }
}

function formatCurrency(amount, currency = userCurrency || 'USD') {
    const symbol = getCurrencySymbol(currency);
    const formatter = new Intl.NumberFormat('en-US', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    return symbol + formatter.format(amount || 0);
}

// Modal functions
function openAddExpenseModal() {
    document.getElementById('modalTransactionDate').value = new Date().toISOString().split('T')[0];
    loadModalCategories();
    document.getElementById('addExpenseModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function loadModalCategories() {
    authenticatedFetch('/api/categories')
    .then(response => response.json())
    .then(categories => {
        const categorySelect = document.getElementById('modalCategory');
        categorySelect.innerHTML = '<option value="">Select a category</option>';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            option.dataset.subcategories = JSON.stringify(category.subcategories);
            categorySelect.appendChild(option);
        });
    })
    .catch(error => console.error('Error loading categories:', error));
}

function loadModalSubcategories() {
    const categorySelect = document.getElementById('modalCategory');
    const subcategorySelect = document.getElementById('modalSubcategory');
    
    subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
    
    const selectedCategory = categorySelect.options[categorySelect.selectedIndex];
    if (selectedCategory.value && selectedCategory.dataset.subcategories) {
        const subcategories = JSON.parse(selectedCategory.dataset.subcategories);
        subcategories.forEach(subcategory => {
            const option = document.createElement('option');
            option.value = subcategory.id;
            option.textContent = subcategory.name;
            subcategorySelect.appendChild(option);
        });
    }
}

// Modal form submission
document.addEventListener('DOMContentLoaded', function() {
    const addExpenseForm = document.getElementById('addExpenseForm');
    if (addExpenseForm) {
        addExpenseForm.addEventListener('submit', handleModalExpenseSubmit);
    }
});

function handleModalExpenseSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        amount: parseFloat(formData.get('amount')),
        transaction_date: formData.get('transaction_date'),
        description: formData.get('description'),
        comment: formData.get('comment'),
        subcategory_id: parseInt(formData.get('subcategory'))
    };
    
    // Validation
    if (!data.amount || data.amount <= 0) {
        showNotification('Please enter a valid amount', 'error');
        return;
    }
    
    if (!data.transaction_date) {
        showNotification('Please select a transaction date', 'error');
        return;
    }
    
    if (!data.subcategory_id) {
        showNotification('Please select a subcategory', 'error');
        return;
    }
    
    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    submitBtn.disabled = true;
    
    // Make API call
    authenticatedFetch('/api/transactions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        showNotification('Expense added successfully!', 'success');
        closeModal('addExpenseModal');
        resetModalForm();
        loadDashboardData(); // Refresh dashboard data
        // Check for overspending after adding expense
        checkOverspending();
    })
    .catch(error => {
        console.error('Error adding expense:', error);
        const errorMessage = error.error || error.message || 'Error adding expense. Please try again.';
        showNotification(errorMessage, 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function resetModalForm() {
    document.getElementById('addExpenseForm').reset();
    document.getElementById('modalTransactionDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('modalSubcategory').innerHTML = '<option value="">Select a subcategory</option>';
}

function checkBudgetBalance() {
    authenticatedFetch('/api/budget/balance-check')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (!data.is_balanced) {
            showBudgetAlert(data);
        } else {
            hideBudgetAlert();
        }
    })
    .catch(error => {
        console.error('Error checking budget balance:', error);
        // Don't show error notification for balance check failures
    });
}

function showBudgetAlert(balanceData) {
    const alert = document.getElementById('budget-balance-alert');
    const alertText = document.getElementById('budget-alert-text');
    
    const deficit = balanceData.deficit || 0;
    const totalIncome = balanceData.total_income || 0;
    const totalAllocated = balanceData.total_allocated || 0;
    
    alertText.textContent = `Your total allocated budget (${formatCurrency(totalAllocated, userCurrency)}) exceeds your total income (${formatCurrency(totalIncome, userCurrency)}) by ${formatCurrency(deficit, userCurrency)}. Please adjust your budget allocations.`;
    
    alert.style.display = 'block';
}

function hideBudgetAlert() {
    const alert = document.getElementById('budget-balance-alert');
    alert.style.display = 'none';
}

function dismissBudgetAlert() {
    hideBudgetAlert();
}

function checkOverspending() {
    console.log('Checking overspending...');
    authenticatedFetch('/api/budget/overspending-check')
    .then(response => {
        console.log('Overspending response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Overspending data received:', data);
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (data.has_overspending) {
            console.log('Overspending detected, showing alert');
            showOverspendingAlert(data);
        } else {
            console.log('No overspending detected, hiding alert');
            hideOverspendingAlert();
        }
    })
    .catch(error => {
        console.error('Error checking overspending:', error);
        // Don't show error notification for overspending check failures
    });
}

function showOverspendingAlert(overspendingData) {
    console.log('showOverspendingAlert called with data:', overspendingData);
    const alert = document.getElementById('overspending-alert');
    const alertText = document.getElementById('overspending-alert-text');
    const detailsContainer = document.getElementById('overspending-details');
    
    console.log('Alert element found:', alert);
    console.log('Alert text element found:', alertText);
    console.log('Details container found:', detailsContainer);
    
    const totalOverspent = overspendingData.total_overspent_categories;
    const overspentCategories = overspendingData.overspent_categories;
    
    alertText.textContent = `You have exceeded your allocated budget in ${totalOverspent} categor${totalOverspent === 1 ? 'y' : 'ies'}.`;
    
    // Create details for overspent categories
    detailsContainer.innerHTML = overspentCategories.map(category => `
        <div class="overspent-item">
            <div class="overspent-info">
                <span class="category-name">${category.category_name} - ${category.subcategory_name}</span>
                <span class="overspent-amount">${formatCurrency(category.overspent_amount, userCurrency)} over</span>
            </div>
            <div class="overspent-stats">
                <span class="allocated">Allocated: ${formatCurrency(category.allocated, userCurrency)}</span>
                <span class="spent">Spent: ${formatCurrency(category.spent, userCurrency)}</span>
                <span class="percentage">${Math.round(category.overspent_percentage)}% over</span>
            </div>
        </div>
    `).join('');
    
    console.log('Setting alert display to block');
    alert.style.display = 'block';
}

function hideOverspendingAlert() {
    const alert = document.getElementById('overspending-alert');
    alert.style.display = 'none';
}

function dismissOverspendingAlert() {
    hideOverspendingAlert();
}

function showNoBudgetMessage() {
    // Hide main dashboard content
    const mainContent = document.querySelector('.dashboard-content');
    if (mainContent) {
        mainContent.style.display = 'none';
    }
    
    // Show no budget message
    const noBudgetMessage = document.getElementById('no-budget-message');
    if (noBudgetMessage) {
        noBudgetMessage.style.display = 'block';
    }
    
    // Update budget period indicator
    document.getElementById('current-budget-name').textContent = 'No Budget';
}

function hideNoBudgetMessage() {
    // Show main dashboard content
    const mainContent = document.querySelector('.dashboard-content');
    if (mainContent) {
        mainContent.style.display = 'block';
    }
    
    // Hide no budget message
    const noBudgetMessage = document.getElementById('no-budget-message');
    if (noBudgetMessage) {
        noBudgetMessage.style.display = 'none';
    }
}

function calculateDaysRemaining(budgetData) {
    if (!budgetData || !budgetData.end_date || !budgetData.start_date) {
        document.getElementById('daysRemaining').textContent = '0';
        LoadingManager.hide('days-card');
        return;
    }
    
    const startDate = new Date(budgetData.start_date);
    const endDate = new Date(budgetData.end_date);
    const today = new Date();
    
    // Set time to start of day for accurate day calculation
    today.setHours(0, 0, 0, 0);
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(0, 0, 0, 0);
    
    // If we're before the budget period starts, show the full period duration
    if (today < startDate) {
        const fullPeriodDays = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 3600 * 24)) + 1;
        document.getElementById('daysRemaining').textContent = fullPeriodDays.toString();
        LoadingManager.hide('days-card');
        return;
    }
    
    // If we're within the budget period, show days remaining
    if (today >= startDate && today <= endDate) {
        const timeDiff = endDate.getTime() - today.getTime();
        const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
        const displayDays = Math.max(0, daysRemaining);
        document.getElementById('daysRemaining').textContent = displayDays.toString();
        LoadingManager.hide('days-card');
        return;
    }
    
    // If we're after the budget period, show 0
    document.getElementById('daysRemaining').textContent = '0';
    LoadingManager.hide('days-card');
}

// Chart functionality
let budgetChart = null;

function loadBudgetChart() {
    authenticatedFetch('/api/categories')
    .then(response => response.json())
    .then(categories => {
        // Prepare data for the chart
        const chartData = prepareChartData(categories);
        createBudgetChart(chartData);
        
        // Hide chart loading state
        LoadingManager.hide('chart-container');
    })
    .catch(error => {
        console.error('Error loading chart data:', error);
        // Hide loading state even on error
        LoadingManager.hide('chart-container');
    });
}

function prepareChartData(categories) {
    const data = [];
    const labels = [];
    const colors = [
        '#8B4513', '#DC3545', '#007bff', '#28a745', '#ffc107',
        '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d',
        '#17a2b8', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4',
        '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3'
    ];
    
    let totalAllocated = 0;
    
    categories.forEach((category, index) => {
        const categoryAllocated = category.subcategories.reduce((sum, sub) => sum + (sub.allocated || 0), 0);
        
        if (categoryAllocated > 0) {
            data.push(categoryAllocated);
            labels.push(category.name);
            totalAllocated += categoryAllocated;
        }
    });
    
    return {
        data: data,
        labels: labels,
        colors: colors.slice(0, data.length),
        totalAllocated: totalAllocated
    };
}

function createBudgetChart(chartData) {
    const ctx = document.getElementById('budgetChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (budgetChart) {
        budgetChart.destroy();
    }
    
    budgetChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartData.labels,
            datasets: [{
                data: chartData.data,
                backgroundColor: chartData.colors,
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // We'll create a custom legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const percentage = ((value / chartData.totalAllocated) * 100).toFixed(1);
                            return `${context.label}: ${formatCurrency(value, userCurrency)} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    });
    
    // Create custom legend
    createCustomLegend(chartData);
}

function createCustomLegend(chartData) {
    const legendContainer = document.getElementById('chartLegend');
    legendContainer.innerHTML = '';
    
    chartData.labels.forEach((label, index) => {
        const value = chartData.data[index];
        const percentage = ((value / chartData.totalAllocated) * 100).toFixed(1);
        
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.innerHTML = `
            <div class="legend-color" style="background-color: ${chartData.colors[index]}"></div>
            <span class="legend-label">${label}</span>
            <span class="legend-value">${formatCurrency(value, userCurrency)} (${percentage}%)</span>
        `;
        
        legendContainer.appendChild(legendItem);
    });
}

// Export data functionality
function exportData() {
    showNotification('Preparing Excel export...', 'info');
    
    fetch('/api/user/export-data', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Export failed');
        }
        return response.blob();
    })
    .then(blob => {
        // Create and download Excel file
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `steward-export-${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showNotification('Excel file exported successfully!', 'success');
    })
    .catch(error => {
        console.error('Error exporting data:', error);
        showNotification('Error exporting data. Please try again.', 'error');
    });
}
</script>
{% endblock %}
