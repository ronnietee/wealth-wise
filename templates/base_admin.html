<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{% block title %}Admin Portal - STEWARD{% endblock %}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=6.4">
    <style>
        /* Admin-specific styles */
        .admin-container {
            min-height: 100vh;
            background: var(--bg-color, #f5f5f5);
        }
        
        .admin-nav {
            background: var(--card-bg, #fff);
            border-bottom: 1px solid var(--border-color, #ddd);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .admin-nav-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color, #007bff);
        }
        
        .admin-nav-links {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .admin-content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .notification.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.success {
            background-color: #28a745;
        }
        
        .notification.error {
            background-color: #dc3545;
        }
        
        .notification.warning {
            background-color: #ffc107;
            color: #333;
        }
        
        .notification.info {
            background-color: #17a2b8;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="admin-container">
        <nav class="admin-nav">
            <div class="admin-nav-brand">
                <i class="fas fa-shield-alt"></i> STEWARD Admin
            </div>
            <div class="admin-nav-links">
                <span id="adminUsername" style="color: var(--text-color, #333); margin-right: 15px;"></span>
                <button class="btn btn-danger" onclick="logoutAdmin()" style="padding: 8px 16px;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>
        
        <main class="admin-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Admin-specific JavaScript (no authentication redirects)
        
        // Get admin token (separate from user token)
        function getAdminToken() {
            return localStorage.getItem('adminToken') || '';
        }
        
        // Admin-specific fetch wrapper (doesn't redirect on 401)
        function adminFetch(url, options = {}) {
            const token = getAdminToken();
            
            // Add authorization header if token exists
            if (token) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                };
            }
        
            return fetch(url, options)
                .then(response => {
                    // For admin, if we get 401/403, redirect to admin login (not main app)
                    if (response.status === 401 || response.status === 403) {
                        // Check if we're NOT already on login page
                        if (window.location.pathname !== '/admin/' && !window.location.pathname.includes('/admin/login')) {
                            window.location.href = '/admin/';
                        }
                        throw new Error('Unauthorized');
                    }
                    return response;
                });
        }
        
        // Notification function for admin
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // Admin logout
        async function logoutAdmin() {
            try {
                const response = await fetch('/admin/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getAdminToken()
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Logout error:', response.status, errorText);
                }
            } catch (error) {
                console.error('Logout error:', error);
                // Continue with logout even if request fails
            }
            
            // Clear admin tokens and redirect regardless of API response
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/';
        }
        
        // Check admin session on page load (only for protected admin pages)
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            
            // Skip check for login page
            if (currentPath === '/admin/' || currentPath === '/admin/login') {
                return;
            }
            
            // For protected admin pages, check if we have admin session
            if (currentPath.startsWith('/admin/')) {
                const token = getAdminToken();
                // If no token, server-side check will redirect to login
                // We just ensure we're on an admin page
            }
        });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>

